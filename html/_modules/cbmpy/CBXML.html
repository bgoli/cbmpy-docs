
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cbmpy.CBXML &#8212; CBMPy 0.7.20 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.20',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within CBMPy 0.7.20 documentation"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cbmpy.CBXML</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CBMPy: CBXML module</span>
<span class="sd">===================</span>
<span class="sd">PySCeS Constraint Based Modelling (http://cbmpy.sourceforge.net)</span>
<span class="sd">Copyright (C) 2009-2017 Brett G. Olivier, VU University Amsterdam, Amsterdam, The Netherlands</span>

<span class="sd">This program is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;</span>

<span class="sd">Author: Brett G. Olivier</span>
<span class="sd">Contact email: bgoli@users.sourceforge.net</span>
<span class="sd">Last edit: $Author: bgoli $ ($Id: CBXML.py 648 2018-05-23 20:01:54Z bgoli $)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">## gets rid of &quot;invalid variable name&quot; info</span>
<span class="c1"># pylint: disable=C0103</span>
<span class="c1">## gets rid of &quot;line to long&quot; info</span>
<span class="c1"># pylint: disable=C0301</span>
<span class="c1">## use with caution: gets rid of module xxx has no member errors (run once enabled)</span>
<span class="c1"># pylint: disable=E1101</span>

<span class="c1"># preparing for Python 3 port</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="c1"># all unicode literals must first be cast to string for libSBML API - brett</span>
<span class="c1">#from __future__ import unicode_literals</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">cgi</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">ast</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="c1"># this is a hack that needs to be streamlined a bit</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cStringIO</span> <span class="k">as</span> <span class="nn">csio</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span> <span class="k">as</span> <span class="nn">csio</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="k">import</span> <span class="n">getuser</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ELTree</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="k">import</span> <span class="n">getDOMImplementation</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">HTMLParser</span> <span class="k">import</span> <span class="n">HTMLParser</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1">#from html.parser import HTMLParser</span>
    <span class="kn">from</span> <span class="nn">html</span> <span class="k">import</span> <span class="n">parser</span>
    <span class="n">HTMLParser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">HTMLParser</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">CBModel</span>
<span class="c1">#from .CBDataStruct import (MIRIAMannotation, MIRIAMModelAnnotation)</span>
<span class="kn">from</span> <span class="nn">.CBDataStruct</span> <span class="k">import</span> <span class="n">MIRIAMannotation</span>
<span class="kn">from</span> <span class="nn">.CBCommon</span> <span class="k">import</span> <span class="p">(</span><span class="n">checkChemFormula</span><span class="p">,</span> <span class="n">getGPRasDictFromString</span><span class="p">,</span> <span class="n">processSpeciesChargeChemFormulaAnnot</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.CBConfig</span> <span class="k">import</span> <span class="n">__CBCONFIG__</span> <span class="k">as</span> <span class="n">__CBCONFIG__</span>

<span class="n">__DEBUG__</span> <span class="o">=</span> <span class="n">__CBCONFIG__</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">]</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">__CBCONFIG__</span><span class="p">[</span><span class="s1">&#39;VERSION&#39;</span><span class="p">]</span>

<span class="n">_HAVE_SBML_</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">libsbml</span>
    <span class="n">_HAVE_SBML_</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">SBMLreader</span>  <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SBMLReader</span><span class="p">()</span>
    <span class="n">SBMLwriter</span>  <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SBMLWriter</span><span class="p">()</span>

    <span class="n">SBML_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_SPECIES</span> <span class="p">:</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_REACTION</span> <span class="p">:</span> <span class="s1">&#39;reaction&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_COMPARTMENT</span> <span class="p">:</span> <span class="s1">&#39;compartment&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_PARAMETER</span> <span class="p">:</span> <span class="s1">&#39;parameter&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_INITIAL_ASSIGNMENT</span> <span class="p">:</span> <span class="s1">&#39;initialassignment&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_SPECIES_REFERENCE</span> <span class="p">:</span> <span class="s1">&#39;speciesreference&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_UNKNOWN</span> <span class="p">:</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
                  <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">SBML_TYPES</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_FLUXBOUND</span> <span class="p">:</span> <span class="s1">&#39;fluxbound&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_OBJECTIVE</span> <span class="p">:</span> <span class="s1">&#39;objective&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_FLUXOBJECTIVE</span> <span class="p">:</span> <span class="s1">&#39;fluxobjective&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_V1ASSOCIATION</span> <span class="p">:</span> <span class="s1">&#39;geneassociation1&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_GENEASSOCIATION</span> <span class="p">:</span> <span class="s1">&#39;geneassociation2&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_GENEPRODUCT</span> <span class="p">:</span> <span class="s1">&#39;geneproduct&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_GENEPRODUCTASSOCIATION</span> <span class="p">:</span> <span class="s1">&#39;geneproductassociation&#39;</span><span class="p">,</span>
                  <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_FBC_GENEPRODUCTREF</span> <span class="p">:</span> <span class="s1">&#39;geneproductref&#39;</span><span class="p">})</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: No or limited FBC support limited! Please update your libSBML to the latest version.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: SBML support not available, please install libSBML, Python bindings with FBC (sbml.org)&#39;</span><span class="p">)</span>
    <span class="n">SBML_TYPES</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_HAVE_SBML_</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">GROUP_KINDS</span> <span class="o">=</span> <span class="p">{</span><span class="n">libsbml</span><span class="o">.</span><span class="n">GROUP_KIND_CLASSIFICATION</span> <span class="p">:</span> <span class="s1">&#39;classification&#39;</span><span class="p">,</span>
                   <span class="n">libsbml</span><span class="o">.</span><span class="n">GROUP_KIND_PARTONOMY</span> <span class="p">:</span> <span class="s1">&#39;partonomy&#39;</span><span class="p">,</span>
                   <span class="n">libsbml</span><span class="o">.</span><span class="n">GROUP_KIND_COLLECTION</span> <span class="p">:</span> <span class="s1">&#39;collection&#39;</span><span class="p">,</span>
                   <span class="n">libsbml</span><span class="o">.</span><span class="n">GROUP_KIND_UNKNOWN</span> <span class="p">:</span> <span class="s1">&#39;collection&#39;</span>
                   <span class="p">}</span>
    <span class="n">SBML_TYPES</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SBML_GROUPS_GROUP</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: SBML+GROUPS support not available, update to latest version of libSBML if required&#39;</span><span class="p">)</span>
    <span class="n">GROUP_KINDS</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_HAVE_GROUPS_</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_TEMP_XML_FILE_</span> <span class="o">=</span> <span class="s1">&#39;_tmpxml.tmp&#39;</span>
<span class="n">FBA_NS</span> <span class="o">=</span> <span class="s1">&#39;http://www.sbml.org/sbml/level3/version1/fba/version1&#39;</span>
<span class="n">METAPREFIX</span> <span class="o">=</span> <span class="s1">&#39;meta_&#39;</span>

<span class="n">UNIT_DICTIONARY_L2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;metre&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
                   <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;metre&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
                   <span class="s1">&#39;substance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;mole&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
                   <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
                   <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;litre&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
                   <span class="s1">&#39;mmol_per_gDW_per_hr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;mole&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">},</span>
                                           <span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;gram&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                                           <span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                                           <span class="p">}</span>
                   <span class="p">}</span>

<span class="n">UNIT_DICTIONARY</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>\
                            <span class="p">},</span>
                   <span class="s1">&#39;mmol_per_gdw&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;mole&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">},</span>
                                    <span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;gram&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                                    <span class="p">},</span>
                   <span class="s1">&#39;mmol_per_hour&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;mole&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">},</span>
                                     <span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                                     <span class="p">},</span>
                   <span class="s1">&#39;per_hour&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                                   <span class="p">}</span>
                   <span class="p">}</span>
<span class="n">MODEL_UNITS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="s1">&#39;mmol_per_gdw&#39;</span><span class="p">,</span>
               <span class="s1">&#39;substance&#39;</span> <span class="p">:</span> <span class="s1">&#39;mmol_per_gdw&#39;</span><span class="p">,</span>
               <span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="s1">&#39;hour&#39;</span><span class="p">}</span>

<span class="n">SBML_NS</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;http://www.sbml.org/sbml/level3/version1/fbc/version2&#39;</span><span class="p">,</span> <span class="s1">&#39;L3V1FBC2&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level3/version1/fbc/version1&#39;</span><span class="p">,</span> <span class="s1">&#39;L3V1FBC1&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level3/version2/fbc/version2&#39;</span><span class="p">,</span> <span class="s1">&#39;L3V2FBC2&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level3/version2/fbc/version1&#39;</span><span class="p">,</span> <span class="s1">&#39;L3V2FBC1&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level3/version2/core&#39;</span><span class="p">,</span> <span class="s1">&#39;L3V2core&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level3/version1/core&#39;</span><span class="p">,</span> <span class="s1">&#39;L3V1core&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level2/version4&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;http://www.sbml.org/sbml/level2&#39;</span><span class="p">,</span><span class="s1">&#39;L2&#39;</span><span class="p">)]</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">print libsbml.BQB_ENCODES            , 8  # &quot;encodes&quot;,</span>
<span class="sd">print libsbml.BQB_HAS_PART           , 1  # &quot;hasPart&quot;,</span>
<span class="sd">print libsbml.BQB_HAS_PROPERTY       , 10 # &quot;hasProperty&quot;,</span>
<span class="sd">print libsbml.BQB_HAS_VERSION        , 4  # &quot;hasVersion&quot;,</span>
<span class="sd">print libsbml.BQB_IS                 , 0  # &quot;isA&quot;,</span>
<span class="sd">print libsbml.BQB_IS_DESCRIBED_BY    , 6  # &quot;isDescribedBy&quot;,</span>
<span class="sd">print libsbml.BQB_IS_ENCODED_BY      , 7  # &quot;isEncodedBy&quot;,</span>
<span class="sd">print libsbml.BQB_IS_HOMOLOG_TO      , 5  # &quot;isHomologTo&quot;,</span>
<span class="sd">print libsbml.BQB_IS_PART_OF         , 2  # &quot;isPartOf&quot;,</span>
<span class="sd">print libsbml.BQB_IS_PROPERTY_OF     , 11 # &quot;isPropertyOf&quot;,</span>
<span class="sd">print libsbml.BQB_IS_VERSION_OF      , 3  # &quot;isVersionOf&quot;,</span>
<span class="sd">print libsbml.BQB_OCCURS_IN          , 9  # &quot;occursIn&quot;,</span>
<span class="sd">print libsbml.BQB_UNKNOWN            , 12 # None</span>

<span class="sd">print libsbml.BQM_IS                 , 0 # None</span>
<span class="sd">print libsbml.BQM_IS_DERIVED_FROM    , 2 # None</span>
<span class="sd">print libsbml.BQM_IS_DESCRIBED_BY    , 1 # None</span>
<span class="sd">print libsbml.BQM_UNKNOWN            , 3 # None</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">BQ2CBMMAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">8</span>  <span class="p">:</span> <span class="s2">&quot;encodes&quot;</span><span class="p">,</span>
    <span class="mi">1</span>  <span class="p">:</span> <span class="s2">&quot;hasPart&quot;</span><span class="p">,</span>
    <span class="mi">10</span> <span class="p">:</span> <span class="s2">&quot;hasProperty&quot;</span><span class="p">,</span>
    <span class="mi">4</span>  <span class="p">:</span> <span class="s2">&quot;hasVersion&quot;</span><span class="p">,</span>
    <span class="mi">0</span>  <span class="p">:</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span>
    <span class="mi">6</span>  <span class="p">:</span> <span class="s2">&quot;isDescribedBy&quot;</span><span class="p">,</span>
    <span class="mi">7</span>  <span class="p">:</span> <span class="s2">&quot;isEncodedBy&quot;</span><span class="p">,</span>
    <span class="mi">5</span>  <span class="p">:</span> <span class="s2">&quot;isHomologTo&quot;</span><span class="p">,</span>
    <span class="mi">2</span>  <span class="p">:</span> <span class="s2">&quot;isPartOf&quot;</span><span class="p">,</span>
    <span class="mi">11</span> <span class="p">:</span> <span class="s2">&quot;isPropertyOf&quot;</span><span class="p">,</span>
    <span class="mi">3</span>  <span class="p">:</span> <span class="s2">&quot;isVersionOf&quot;</span><span class="p">,</span>
    <span class="mi">9</span>  <span class="p">:</span> <span class="s2">&quot;occursIn&quot;</span><span class="p">,</span>
    <span class="mi">12</span> <span class="p">:</span> <span class="kc">None</span>
<span class="p">}</span>

<span class="n">CBM2BQMAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;encodes&quot;</span>       <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;hasPart&quot;</span>       <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;hasProperty&quot;</span>   <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;hasVersion&quot;</span>    <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;is&quot;</span>            <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;isDescribedBy&quot;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;isEncodedBy&quot;</span>   <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;isHomologTo&quot;</span>   <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;isPartOf&quot;</span>      <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;isPropertyOf&quot;</span>  <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="s2">&quot;isVersionOf&quot;</span>   <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;occursIn&quot;</span>      <span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="kc">None</span>            <span class="p">:</span> <span class="mi">12</span>
<span class="p">}</span>

<span class="n">BQM2CBMMAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span>  <span class="p">:</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span>
    <span class="mi">1</span>  <span class="p">:</span> <span class="s2">&quot;isDescribedBy&quot;</span><span class="p">,</span>
    <span class="mi">2</span>  <span class="p">:</span> <span class="s2">&quot;isDerivedFrom&quot;</span><span class="p">,</span>
    <span class="mi">3</span> <span class="p">:</span> <span class="kc">None</span>
<span class="p">}</span>

<span class="n">CBM2BQMMAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;is&quot;</span>            <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;isDescribedBy&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;isDerivedFrom&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="kc">None</span>            <span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="n">re_html_p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;.*?&lt;/p&gt;&quot;</span><span class="p">)</span>
<span class="n">re_html_cobra_p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&lt;html:p&gt;.*?&lt;/html:p&gt;&quot;</span><span class="p">)</span>
<span class="n">re_html_span</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&lt;span&gt;.*?&lt;/span&gt;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MLStripper"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.MLStripper">[docs]</a><span class="k">class</span> <span class="nc">MLStripper</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for stripping a string of HTML/XML used from:</span>
<span class="sd">    http://stackoverflow.com/questions/753052/strip-html-from-strings-in-python</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Strip a string of HTML/XML tags</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fed</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">d_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="n">d_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">data</span></div>

<span class="n">__tagStripper__</span> <span class="o">=</span> <span class="n">MLStripper</span><span class="p">()</span>

<div class="viewcode-block" id="xml_stripTags"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_stripTags">[docs]</a><span class="k">def</span> <span class="nf">xml_stripTags</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strip a string of HTML/XML, returns a string</span>

<span class="sd">     - *html* the string containing html</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tagStripper__</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">__tagStripper__</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">formatSbmlId</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">out</span>
    <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="sbml_readSBML2FBA"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_readSBML2FBA">[docs]</a><span class="k">def</span> <span class="nf">sbml_readSBML2FBA</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_sbml_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fake_boundary_species_search</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in an SBML Level 2 file with FBA annotation where and return either a CBM model object</span>
<span class="sd">    or a (cbm_mod, sbml_mod) pair if return_sbml_model=True</span>

<span class="sd">     - *fname* is the filename</span>
<span class="sd">     - *work_dir* is the working directory (only used if not None)</span>
<span class="sd">     - *return_sbml_model* [default=False] return a a (cbm_mod, sbml_mod) pair</span>
<span class="sd">     - *fake_boundary_species_search* [default=False] after looking for the boundary_condition of a species search for overloaded id&#39;s &lt;id&gt;_b</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SBML not available ... install libSBML with Python bindings for SBML support&quot;</span>
    <span class="k">if</span> <span class="n">work_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">readSBML</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">getModel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">M</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid SBML, no model will be generated&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_sbml_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">D</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">csio</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
    <span class="n">model_description</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">XMLNode_convertXMLNodeToString</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNotes</span><span class="p">())</span>
    <span class="n">model_description</span> <span class="o">=</span> <span class="n">xml_stripTags</span><span class="p">(</span><span class="n">model_description</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1">#print(model_description)</span>

    <span class="n">__HAVE_FBA_ANOT__</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">__HAVE_FBA_ANOT_OBJ__</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ANOT</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ANOT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">__HAVE_FBA_ANOT__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;&lt;fba:listOfConstraints&gt;&#39;</span> <span class="ow">in</span> <span class="n">ANOT</span><span class="p">:</span>
            <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#if &#39;&lt;fba:listOfObjectives/&gt;&#39; in ANOT:</span>
        <span class="k">if</span> <span class="s1">&#39;&lt;fba:listOfFluxes&gt;&#39;</span> <span class="ow">in</span> <span class="n">ANOT</span><span class="p">:</span>
            <span class="n">__HAVE_FBA_ANOT_OBJ__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># fix some compatability stuff</span>
        <span class="n">ANOT</span> <span class="o">=</span> <span class="n">ANOT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;annotation&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;annotation xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot; xmlns:fba=&quot;http://www.sbml.org/sbml/level3/version1/fba/version1&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="c1">#_TEMP_XML_FILE_ = createTempFileName()</span>
        <span class="c1">#_TEMP_XML_FILE_ = os.path.join(work_dir, _TEMP_XML_FILE_)</span>
        <span class="c1">#F = open(_TEMP_XML_FILE_,&#39;w&#39;)</span>
        <span class="n">F</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ANOT</span><span class="p">)</span>
        <span class="n">F</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#F.flush()</span>
        <span class="c1">#F.close()</span>
    <span class="k">del</span> <span class="n">ANOT</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">__HAVE_FBA_ANOT_OBJ__</span><span class="p">:</span>
        <span class="n">__HAVE_FBA_ANOT__</span> <span class="o">=</span> <span class="kc">False</span>



    <span class="n">SPEC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumSpecies</span><span class="p">()):</span>
        <span class="n">SBSp</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
        <span class="n">boundCon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getBoundaryCondition</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Real boundary metabolite: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
            <span class="n">boundCon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">CF</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># chemical formula</span>
        <span class="n">CHRG</span> <span class="o">=</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getCharge</span><span class="p">()</span>
        <span class="c1">#if CHRG == 0:</span>
            <span class="c1">#CHRG = None</span>
        <span class="n">NM</span> <span class="o">=</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="c1"># get name</span>
        <span class="c1"># to strip a BiGG file see CBTools</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Species</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">boundary</span><span class="o">=</span><span class="n">boundCon</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">NM</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getInitialConcentration</span><span class="p">(),</span> <span class="n">compartment</span><span class="o">=</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getCompartment</span><span class="p">(),</span> <span class="n">charge</span><span class="o">=</span><span class="n">CHRG</span><span class="p">,</span> <span class="n">chemFormula</span><span class="o">=</span><span class="n">CF</span><span class="p">)</span>
        <span class="c1"># process notes field, get rid of &lt;head&gt;, &lt;body&gt; elements</span>
        <span class="n">specNotes</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">XMLNode_convertXMLNodeToString</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getNotes</span><span class="p">())</span>
        <span class="n">S</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readCOBRANote</span><span class="p">(</span><span class="n">specNotes</span><span class="p">)</span>

        <span class="c1"># Note: chemFormula works will have to see about charge GETFROMNAME!!!</span>
        <span class="n">processSpeciesChargeChemFormulaAnnot</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">getFromName</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwriteCharge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#S.setAnnotation(&#39;note&#39;, specNotes)</span>
        <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">SBSp</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">S</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
        <span class="k">del</span> <span class="n">manot</span>
        <span class="n">SPEC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

    <span class="n">boundary_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SPEC</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_boundary</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fake_boundary_species_search</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: No boundary species detected, if this is not what you expect try searching for boundary species using &lt;name&gt;_b (with </span><span class="se">\&quot;</span><span class="s1">fake_boundary_species_search=True</span><span class="se">\&quot;</span><span class="s1">)?&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumSpecies</span><span class="p">()):</span>
                <span class="n">SBSp</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sid</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_b&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fake boundary (_b) metabolite added: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
                    <span class="n">SPEC</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">is_boundary</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">boundary_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SPEC</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_boundary</span><span class="p">]</span>
    <span class="n">spec_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SPEC</span><span class="p">]</span>

    <span class="n">REAC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reactionsReversability</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumReactions</span><span class="p">()):</span>
        <span class="n">SBRe</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">R_id</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
        <span class="n">reagents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">EXREAC</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rea</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNumReactants</span><span class="p">()):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getReactant</span><span class="p">(</span><span class="n">rea</span><span class="p">)</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">()</span>
            <span class="n">stoi</span> <span class="o">=</span> <span class="o">-</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getReactant</span><span class="p">(</span><span class="n">rea</span><span class="p">)</span><span class="o">.</span><span class="n">getStoichiometry</span><span class="p">()</span>
            <span class="c1">#reagents.append((stoi,spec))</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reagents</span><span class="p">:</span>
                <span class="n">reagents</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reagents</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">boundary_species</span><span class="p">:</span>
                <span class="n">EXREAC</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNumProducts</span><span class="p">()):</span>
            <span class="n">spec2</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getProduct</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">()</span>
            <span class="n">stoi2</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getProduct</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">getStoichiometry</span><span class="p">()</span>
            <span class="c1">#reagents.append((stoi2, spec2))</span>
            <span class="k">if</span> <span class="n">spec2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reagents</span><span class="p">:</span>
                <span class="n">reagents</span><span class="p">[</span><span class="n">spec2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reagents</span><span class="p">[</span><span class="n">spec2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec2</span> <span class="ow">in</span> <span class="n">boundary_species</span><span class="p">:</span>
                <span class="n">EXREAC</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Reaction</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">reversible</span><span class="o">=</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getReversible</span><span class="p">())</span>
        <span class="n">reactionsReversability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getReversible</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reagents</span><span class="p">:</span>
            <span class="n">R</span><span class="o">.</span><span class="n">addReagent</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">Reagent</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">reagents</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
            <span class="c1"># TODO check this; I&#39;m almost sure it is nore needed anymore</span>
            <span class="c1">#if R.getId() not in SPEC[spec_id.index(r[1])].reagent_of:</span>
                <span class="c1">#SPEC[spec_id.index(r[1])].reagent_of.append(R.getId())</span>
        <span class="k">del</span> <span class="n">reagents</span>
        <span class="k">if</span> <span class="n">EXREAC</span><span class="p">:</span>
            <span class="n">R</span><span class="o">.</span><span class="n">is_exchange</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#R.setAnnotation(&#39;note&#39;, libsbml.XMLNode_convertXMLNodeToString(SBRe.getNotes()))</span>
        <span class="n">reacNotes</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">XMLNode_convertXMLNodeToString</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNotes</span><span class="p">())</span>
        <span class="n">R</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readCOBRANote</span><span class="p">(</span><span class="n">reacNotes</span><span class="p">)</span>
        <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">SBRe</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">R</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
        <span class="k">del</span> <span class="n">manot</span>
        <span class="n">REAC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

    <span class="n">CONSTR</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">OBJFUNCout</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">objfunc_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">multiobj</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">__HAVE_FBA_ANOT__</span><span class="p">:</span>
        <span class="c1">#root = ELTree.ElementTree(file=os.path.join(work_dir, _TEMP_XML_FILE_))</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ELTree</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
        <span class="n">root_i</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">getiterator</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">root_i</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ri</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}fluxBalance&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">ri</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">rootfba</span> <span class="o">=</span> <span class="n">ELTree</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span>
                <span class="n">root_fba_i</span> <span class="o">=</span> <span class="n">rootfba</span><span class="o">.</span><span class="n">getiterator</span><span class="p">()</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">root_fba_i</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="ow">and</span> <span class="n">ret</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}listOfConstraints&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">chld</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chld</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
                    <span class="n">attrib</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">attrib</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                        <span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">:</span>  <span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)})</span>
                    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrib</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">__HAVE_FBA_ANOT_OBJ__</span> <span class="ow">and</span> <span class="n">ret</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}listOfObjectives&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No objectives in listOfObjectives&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">activeId</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}activeObjective&#39;</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="n">activeId</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}activeObjective&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                        <span class="c1">##  print obj.attrib</span>
                        <span class="k">if</span> <span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}type&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                            <span class="n">ftype</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}type&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ftype</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1">##  raw_input(ftype)</span>
                        <span class="n">sid</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="c1">#multiobj = []</span>
                        <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                            <span class="n">fo</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">cc_</span> <span class="ow">in</span> <span class="n">c_</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
                                <span class="n">fo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc_</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
                            <span class="n">multiobj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fo</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">objfunc_data</span><span class="p">)</span>
                        <span class="n">obj_</span> <span class="o">=</span> <span class="n">multiobj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">flobj_</span> <span class="ow">in</span> <span class="n">obj_</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">flobj_</span><span class="p">:</span>
                                <span class="n">flobj_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{http://www.sbml.org/sbml/level3/version1/fba/version1}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">:</span>  <span class="n">flobj_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)})</span>
                            <span class="n">flobj_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="n">ftype</span><span class="p">})</span>
                            <span class="n">flobj_</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">sid</span><span class="p">})</span>



        <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">boundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">LboundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">UboundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">AboundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DefinedReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">DefinedReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;C_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cntr</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;greater&#39;</span><span class="p">,</span><span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">]:</span>
                    <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
                    <span class="n">LboundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;less&#39;</span><span class="p">,</span><span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">]:</span>
                    <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>
                    <span class="n">UboundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">]:</span>
                    <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;equal&#39;</span>
                    <span class="n">AboundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span> <span class="n">O</span><span class="p">)</span>
            <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span>\
                                            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])))</span>
            <span class="n">cntr</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">boundReactionIDs</span><span class="p">:</span>
                <span class="n">boundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>

        <span class="c1"># undefined flux bounds are given infinite value</span>
        <span class="n">ubcntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">##  print boundReactionIDs</span>
        <span class="c1">##  print reactionIDs</span>

        <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reactionIDs</span><span class="p">)):</span>
            <span class="c1">##  print reactionIDs[J], reactionsReversability[J]</span>
            <span class="n">LBt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">UBt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ABt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DefinedReactionIDs</span><span class="p">:</span>
                <span class="n">LBt</span> <span class="o">=</span> <span class="n">UBt</span> <span class="o">=</span> <span class="n">ABt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">LboundReactionIDs</span><span class="p">:</span>
                <span class="n">LBt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">UboundReactionIDs</span><span class="p">:</span>
                <span class="n">UBt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">AboundReactionIDs</span><span class="p">:</span>
                <span class="n">ABt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">LBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">UBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ABt</span><span class="p">:</span>
                <span class="c1">#print &#39;not LBt and not UBt and not ABt&#39;</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reactionsReversability</span><span class="p">[</span><span class="n">J</span><span class="p">]:</span>
                    <span class="c1">##  print &#39;Adding reversible&#39;</span>
                    <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">##  print &#39;Adding irreversible&#39;</span>
                    <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;upper&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">LBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ABt</span><span class="p">:</span>
                <span class="c1">#print &#39;not LBt and not ABt&#39;</span>
                <span class="c1">#print reactionIDs[J]</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1">#print &#39;Added new lower bound&#39;, newId</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">UBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ABt</span><span class="p">:</span>
                <span class="c1">#print &#39;not UBt and not ABt&#39;</span>
                <span class="c1"># print reactionIDs[J]</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;upper&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># print &#39;Added new upper bound&#39;, newId</span>

    <span class="c1">#printl(CONSTR)</span>
    <span class="c1">#printl(__HAVE_FBA_ANOT_BNDS__)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">CONSTR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">REAC</span><span class="p">:</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">r_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r_</span><span class="o">.</span><span class="n">reversible</span><span class="p">:</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_bnd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_bnd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="s1">&#39;upper&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_bnd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_bnd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="s1">&#39;upper&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

    <span class="c1"># build model</span>
    <span class="n">fm</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">sourcefile</span> <span class="o">=</span> <span class="n">fname</span>
    <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
    <span class="k">del</span> <span class="n">manot</span>
    <span class="n">sbmh</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getModelHistory</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sbmh</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cdate</span> <span class="o">=</span> <span class="n">sbmh</span><span class="o">.</span><span class="n">getCreatedDate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cdate</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdate</span><span class="o">.</span><span class="n">getYear</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getMonth</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getDay</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getHour</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getMinute</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getSecond</span><span class="p">())</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setCreatedDate</span><span class="p">(</span><span class="n">cdate</span><span class="p">)</span>
        <span class="n">mdate</span> <span class="o">=</span> <span class="n">sbmh</span><span class="o">.</span><span class="n">getModifiedDate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mdate</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdate</span><span class="o">.</span><span class="n">getYear</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getMonth</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getDay</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getHour</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getMinute</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getSecond</span><span class="p">())</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setModifiedDate</span><span class="p">(</span><span class="n">mdate</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sbmh</span><span class="o">.</span><span class="n">getNumCreators</span><span class="p">()):</span>
            <span class="n">sbc</span> <span class="o">=</span> <span class="n">sbmh</span><span class="o">.</span><span class="n">getCreator</span><span class="p">(</span><span class="n">m_</span><span class="p">)</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">addModelCreator</span><span class="p">(</span><span class="n">sbc</span><span class="o">.</span><span class="n">getGivenName</span><span class="p">(),</span> <span class="n">sbc</span><span class="o">.</span><span class="n">getFamilyName</span><span class="p">(),</span> <span class="n">sbc</span><span class="o">.</span><span class="n">getOrganisation</span><span class="p">(),</span> <span class="n">sbc</span><span class="o">.</span><span class="n">getEmail</span><span class="p">())</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model_name</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">model_description</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SPEC</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">REAC</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addReaction</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">create_default_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CONSTR</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addFluxBound</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiobj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">otype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">obj_</span> <span class="ow">in</span> <span class="n">multiobj</span><span class="p">:</span>
            <span class="n">flobjs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fobj_</span> <span class="ow">in</span> <span class="n">obj_</span><span class="p">:</span>
                <span class="n">otype</span> <span class="o">=</span> <span class="n">fobj_</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="n">oid</span> <span class="o">=</span> <span class="n">fobj_</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">flobjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxObjective</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_flobj&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fobj_</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">fobj_</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">]),</span> <span class="n">fobj_</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span>
                                                    <span class="nb">float</span><span class="p">(</span><span class="n">fobj_</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">])))</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">otype</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiobj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">addObjective</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">o</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="n">activeId</span><span class="p">:</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">addObjective</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">addObjective</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">OBJFUNCout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">activeId</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">flobjs</span><span class="p">:</span>
                <span class="n">o</span><span class="o">.</span><span class="n">addFluxObjective</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">SPEC</span><span class="p">,</span> <span class="n">REAC</span><span class="p">,</span> <span class="n">CONSTR</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">F</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">F</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: File deletion failure&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">__HAVE_FBA_ANOT__</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: Missing FBA annotations found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">__HAVE_FBA_ANOT_BNDS__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: No FluxBounds defined (generic bounds created)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">__HAVE_FBA_ANOT_OBJ__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: No Objective function defined please create one&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">_SBML_LEVEL_</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">buildStoichMatrix</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: unable to construct stoichiometric matrix&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_sbml_model</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">M</span><span class="p">,</span> <span class="n">D</span>
        <span class="k">return</span> <span class="n">fm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fm</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span></div>

<div class="viewcode-block" id="xml_createSBML2FBADoc"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_createSBML2FBADoc">[docs]</a><span class="k">def</span> <span class="nf">xml_createSBML2FBADoc</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a &#39;document&#39; to store the SBML2FBA annotation, returns:</span>

<span class="sd">     - *DOC* a minidom document</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DOM</span> <span class="o">=</span> <span class="n">getDOMImplementation</span><span class="p">()</span>
    <span class="n">DOC</span> <span class="o">=</span> <span class="n">DOM</span><span class="o">.</span><span class="n">createDocument</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:fluxBalance&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">DOC</span><span class="o">.</span><span class="n">documentElement</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;xmlns:fba&#39;</span><span class="p">,</span> <span class="n">FBA_NS</span><span class="p">)</span>
    <span class="n">TOP</span> <span class="o">=</span> <span class="n">DOC</span><span class="o">.</span><span class="n">documentElement</span>
    <span class="n">LoC</span> <span class="o">=</span> <span class="n">DOC</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:listOfConstraints&#39;</span><span class="p">)</span>
    <span class="n">TOP</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">LoC</span><span class="p">)</span>
    <span class="n">LoO</span> <span class="o">=</span> <span class="n">DOC</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:listOfObjectives&#39;</span><span class="p">)</span>
    <span class="n">TOP</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">LoO</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DOC</span></div>

<div class="viewcode-block" id="xml_viewSBML2FBAXML"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_viewSBML2FBAXML">[docs]</a><span class="k">def</span> <span class="nf">xml_viewSBML2FBAXML</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a minidom XML document to screen or file, arguments:</span>

<span class="sd">     - *document* a minidom XML document</span>
<span class="sd">     - *fname* [default=None] by default print to screen or write to file fname</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">##  print DOC.toxml(&#39;UTF-8&#39;)</span>
    <span class="c1">##  print document.toprettyxml(indent=&#39; &#39;,newl=&#39;\n&#39;,encoding=&#39;UTF-8&#39;)</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">FO</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">writexml</span><span class="p">(</span><span class="n">FO</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">addindent</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">newl</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="n">FO</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">FO</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="xml_addSBML2FBAFluxBound"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_addSBML2FBAFluxBound">[docs]</a><span class="k">def</span> <span class="nf">xml_addSBML2FBAFluxBound</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fbid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an SBML3FBA flux bound to the document:</span>

<span class="sd">     - *document* a minidom XML document created by xml_createSBML2FBADoc</span>
<span class="sd">     - *rid* the reaction id</span>
<span class="sd">     - *operator* one of [&#39;greater&#39;,&#39;greaterEqual&#39;,&#39;less&#39;,&#39;lessEqual&#39;,&#39;equal&#39;,&#39;&gt;&#39;,&#39;&gt;=&#39;,&#39;&lt;&#39;,&#39;&lt;=&#39;,&#39;=&#39;]</span>
<span class="sd">     - *value* a float which will be cast to a string using str(value)</span>
<span class="sd">     - *fbid* the flux bound id, autogenerated by default</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">OPER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;greater&#39;</span><span class="p">,</span><span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span><span class="s1">&#39;less&#39;</span><span class="p">,</span><span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">OPER</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bad operator </span><span class="si">%s</span><span class="s1"> should be one of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">OPER</span><span class="p">))</span>
    <span class="n">LoC</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;fba:listOfConstraints&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:constraint&#39;</span><span class="p">)</span>
    <span class="n">F</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:reaction&#39;</span><span class="p">,</span> <span class="n">rid</span><span class="p">)</span>
    <span class="n">F</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:operation&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;inf&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;-inf&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">F</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fbid</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;greater&#39;</span><span class="p">,</span><span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">]:</span>
            <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;less&#39;</span><span class="p">,</span><span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">]:</span>
            <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">]:</span>
            <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;equal&#39;</span>
        <span class="n">fbid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">O</span><span class="p">)</span>

    <span class="c1">#METAID</span>
    <span class="c1">#F.setAttributeNS(FBA_NS,&#39;metaid&#39;, fbid)</span>
    <span class="n">F</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">fbid</span><span class="p">)</span>
    <span class="n">LoC</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">F</span><span class="p">)</span></div>

<div class="viewcode-block" id="xml_createListOfFluxObjectives"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_createListOfFluxObjectives">[docs]</a><span class="k">def</span> <span class="nf">xml_createListOfFluxObjectives</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">fluxObjectives</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a list of fluxObjectives to add to an Objective:</span>

<span class="sd">     - *document* a minidom XML document created by xml_createSBML2FBADoc</span>
<span class="sd">     - *fluxobjs* a list of (rid, coefficient) tuples</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LoF</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:listOfFluxes&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">F</span> <span class="ow">in</span> <span class="n">fluxObjectives</span><span class="p">:</span>
        <span class="n">FO</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:fluxObjective&#39;</span><span class="p">)</span>
        <span class="n">FO</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:reaction&#39;</span><span class="p">,</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">FO</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:coefficient&#39;</span><span class="p">,</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">LoF</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">FO</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">LoF</span></div>

<div class="viewcode-block" id="xml_createSBML2FBAObjective"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_createSBML2FBAObjective">[docs]</a><span class="k">def</span> <span class="nf">xml_createSBML2FBAObjective</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">sense</span><span class="p">,</span> <span class="n">fluxObjectives</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a list of fluxObjectives to add to an Objective:</span>

<span class="sd">     - *document* a minidom XML document created by xml_createSBML2FBADoc</span>
<span class="sd">     - *oid* the objective id</span>
<span class="sd">     - *sense* a string containing the objective sense either: **maximize** or **minimize**</span>
<span class="sd">     - *fluxObjectives* a list of (rid, coefficient) tuples</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sense</span> <span class="o">=</span> <span class="n">sense</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sense</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">sense</span> <span class="o">=</span> <span class="s1">&#39;maximize&#39;</span>
    <span class="k">if</span> <span class="n">sense</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">sense</span> <span class="o">=</span> <span class="s1">&#39;minimize&#39;</span>
    <span class="k">if</span> <span class="n">sense</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;maximise&#39;</span><span class="p">,</span> <span class="s1">&#39;minimise&#39;</span><span class="p">]:</span>
        <span class="n">sense</span> <span class="o">=</span> <span class="n">sense</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;se&#39;</span><span class="p">,</span><span class="s1">&#39;ze&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sense</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="s1">&#39;minimize&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Type must be [&#39;maximize&#39;, &#39;minimize&#39;] not </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sense</span>
    <span class="n">OBJ</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:objective&#39;</span><span class="p">)</span>
    <span class="n">OBJ</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">oid</span><span class="p">)</span>
    <span class="c1">#METAID</span>
    <span class="c1">#OBJ.setAttributeNS(FBA_NS,&#39;metaid&#39;, oid)</span>
    <span class="n">OBJ</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:type&#39;</span><span class="p">,</span> <span class="n">sense</span><span class="p">)</span>
    <span class="n">LoF</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:listOfFluxes&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">F</span> <span class="ow">in</span> <span class="n">fluxObjectives</span><span class="p">:</span>
        <span class="n">FO</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElementNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span> <span class="s1">&#39;fba:fluxObjective&#39;</span><span class="p">)</span>
        <span class="n">FO</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:reaction&#39;</span><span class="p">,</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">FO</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:coefficient&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">LoF</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">FO</span><span class="p">)</span>
    <span class="n">OBJ</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">LoF</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OBJ</span></div>

<div class="viewcode-block" id="xml_addSBML2FBAObjective"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_addSBML2FBAObjective">[docs]</a><span class="k">def</span> <span class="nf">xml_addSBML2FBAObjective</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an objective element to the documents listOfObjectives and sets the active attribute:</span>

<span class="sd">     - *document* a minidom XML document created by `xml_createSBML2FBADoc`</span>
<span class="sd">     - *objective* a minidom XML objective element created with `xml_createSBML2FBAObjective`</span>
<span class="sd">     - *active* [default=True] a boolean flag specifiying whether this objective is active</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LoO</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;fba:listOfObjectives&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">xid</span> <span class="o">=</span> <span class="n">objective</span><span class="o">.</span><span class="n">getAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">LoO</span><span class="o">.</span><span class="n">setAttributeNS</span><span class="p">(</span><span class="n">FBA_NS</span><span class="p">,</span><span class="s1">&#39;fba:activeObjective&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting active objective: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xid</span><span class="p">))</span>
    <span class="n">LoO</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span></div>


<div class="viewcode-block" id="xml_getSBML2FBAannotation"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.xml_getSBML2FBAannotation">[docs]</a><span class="k">def</span> <span class="nf">xml_getSBML2FBAannotation</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an FBA model object and returns the SBML3FBA annotation as an XML string:</span>

<span class="sd">     - *fba* an fba model object</span>
<span class="sd">     - *fname* [default=None] if supplied the XML will be written to file *fname*</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DOC</span> <span class="o">=</span> <span class="n">xml_createSBML2FBADoc</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">flux_bounds</span><span class="p">:</span>
        <span class="c1">##  print f.value</span>
        <span class="n">xml_addSBML2FBAFluxBound</span><span class="p">(</span><span class="n">DOC</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">reaction</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
        <span class="n">fluxobjs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fo</span><span class="o">.</span><span class="n">reaction</span><span class="p">,</span> <span class="n">fo</span><span class="o">.</span><span class="n">coefficient</span><span class="p">)</span> <span class="k">for</span> <span class="n">fo</span> <span class="ow">in</span>  <span class="n">o</span><span class="o">.</span><span class="n">fluxObjectives</span><span class="p">]</span>
        <span class="n">OBJ</span> <span class="o">=</span> <span class="n">xml_createSBML2FBAObjective</span><span class="p">(</span><span class="n">DOC</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">fluxobjs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fba</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="n">fba</span><span class="o">.</span><span class="n">activeObjIdx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">xml_addSBML2FBAObjective</span><span class="p">(</span><span class="n">DOC</span><span class="p">,</span> <span class="n">OBJ</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xml_addSBML2FBAObjective</span><span class="p">(</span><span class="n">DOC</span><span class="p">,</span> <span class="n">OBJ</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xml_viewSBML2FBAXML</span><span class="p">(</span><span class="n">DOC</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DOC</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">newl</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="sbml_createModelL2"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_createModelL2">[docs]</a><span class="k">def</span> <span class="nf">sbml_createModelL2</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an SBML model and document:</span>

<span class="sd">     - *fba* a PySCeSCBM model instance</span>
<span class="sd">     - *level* always 2</span>
<span class="sd">     - *version* always 1</span>

<span class="sd">    and returns:</span>

<span class="sd">     - *model* an SBML model</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SBML_LEVEL</span> <span class="o">=</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SBML_VERSION</span> <span class="o">=</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mid0</span> <span class="o">=</span> <span class="s1">&#39;FBAModel&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mid0</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>

    <span class="n">mid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">mid0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
            <span class="n">mid</span> <span class="o">+=</span> <span class="n">l</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="s1">&#39;id_&#39;</span> <span class="o">+</span> <span class="n">mid</span>

    <span class="n">mname</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
    <span class="k">if</span>  <span class="n">mname</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">]:</span>
        <span class="n">mname</span> <span class="o">=</span> <span class="s1">&#39;SBML_CB_MODEL&#39;</span>


    <span class="k">if</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">getLibSBMLVersion</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">40000</span><span class="p">:</span>
        <span class="n">document</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SBMLDocument</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">setLevelAndVersion</span><span class="p">(</span><span class="n">SBML_LEVEL</span><span class="p">,</span> <span class="n">SBML_VERSION</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#document = libsbml.SBMLDocument(SBML_LEVEL, SBML_VERSION)</span>
        <span class="n">document</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SBMLDocument</span><span class="p">(</span><span class="n">SBML_LEVEL</span><span class="p">,</span> <span class="n">SBML_VERSION</span><span class="p">)</span>
    <span class="n">document</span><span class="o">.</span><span class="n">getNamespaces</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createModel</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="o">+</span><span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
    <span class="c1">## can&#39;t do this right now with the custom annotations</span>
    <span class="c1">#miriam = fba.miriam.getAllMIRIAMUris()</span>
    <span class="c1">#print &#39;miriam&#39;, miriam</span>
    <span class="c1">#if len(miriam) &gt; 0:</span>
        <span class="c1">#sbml_setCVterms(model, miriam, model=True)</span>
    <span class="c1">## while this may look right it totally screws up things later, notably reaction reagents don&#39;t get set</span>
    <span class="c1">#ns = model.getNamespaces()</span>
    <span class="c1">#ns.add(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;html&quot;)</span>
    <span class="c1">#model.setNamespaces(ns)</span>
    <span class="c1">#print model.getNamespaces()</span>

        <span class="c1">##  document = libsbml.SBMLDocument(SBML_LEVEL, SBML_VERSION)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">document</span></div>

<span class="k">def</span> <span class="nf">sbml_setCompartmentsL2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">compartments</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: no compartments defined adding one called </span><span class="se">\&quot;</span><span class="s1">cell</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">compartments</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cell&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;dimensions&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">}})</span>
    <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
        <span class="n">comp_def</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createCompartment</span><span class="p">()</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">compartments</span><span class="p">[</span><span class="n">cs</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">compartments</span><span class="p">[</span><span class="n">cs</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setVolume</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">compartments</span><span class="p">[</span><span class="n">cs</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]))</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="sbml_setCompartmentsL3"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setCompartmentsL3">[docs]</a><span class="k">def</span> <span class="nf">sbml_setCompartmentsL3</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sets the model compartments.</span>

<span class="sd">     - *model* a libSBML model instance</span>
<span class="sd">     - *fba* a PySCeSCBM model instance</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
        <span class="n">comp_def</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createCompartment</span><span class="p">()</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
        <span class="c1"># TODO: look into this for user selectable units</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setUnits</span><span class="p">(</span><span class="s1">&#39;dimensionless&#39;</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># TODO: need to decide what to do here</span>
            <span class="n">comp_def</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp_def</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getSize</span><span class="p">())</span>

        <span class="n">comp_def</span><span class="o">.</span><span class="n">setSpatialDimensions</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getDimensions</span><span class="p">())</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">comp_def</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="o">+</span><span class="n">cs</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span>
            <span class="n">annores</span> <span class="o">=</span> <span class="n">comp_def</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in reaction:&#39;</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">cs</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">comp_def</span><span class="p">,</span> <span class="n">miriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sboterm</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sboterm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sboterm</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">comp_def</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sboterm</span><span class="p">))</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">comp_def</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span></div>

<div class="viewcode-block" id="sbml_setParametersL3Fbc"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setParametersL3Fbc">[docs]</a><span class="k">def</span> <span class="nf">sbml_setParametersL3Fbc</span><span class="p">(</span><span class="n">fbcmod</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add non fluxbound related parameters to the model</span>

<span class="sd">     - *fbcmod* a CBM2SBML instance</span>
<span class="sd">     - *add_cbmpy_anno* [default=True] add CBMPy KeyValueData annotation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">fbcmod</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">par</span><span class="o">.</span><span class="n">_is_fluxbound_</span><span class="p">:</span>
            <span class="n">fbcmod</span><span class="o">.</span><span class="n">createParParameter</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="p">)</span>
            <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: added </span><span class="si">{}</span><span class="s1"> non fluxbound parameters to model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cntr</span><span class="p">))</span></div>

<div class="viewcode-block" id="sbml_setAnnotationsL3Fbc"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setAnnotationsL3Fbc">[docs]</a><span class="k">def</span> <span class="nf">sbml_setAnnotationsL3Fbc</span><span class="p">(</span><span class="n">cbmo</span><span class="p">,</span> <span class="n">sbmlo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add CBMPy Fbase annotations to an SBML object, MIRIAM, SBO, Notes. Should</span>
<span class="sd">    be called last when creating SBML objects.</span>

<span class="sd">     - *cbmo* the CBMPy object</span>
<span class="sd">     - *sbmlo* SBML object</span>

<span class="sd">     Note: this function should be used for new code, old code still needs to be</span>
<span class="sd">     refactored.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbmo</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">cbmo</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span>
        <span class="n">annores</span> <span class="o">=</span> <span class="n">sbmlo</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbmo</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">miriam</span> <span class="o">=</span> <span class="n">cbmo</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">sbmlo</span><span class="p">,</span> <span class="n">miriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sboterm</span> <span class="o">=</span> <span class="n">cbmo</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sboterm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sboterm</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">sbmlo</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sboterm</span><span class="p">))</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">cbmo</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">sbmlo</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span></div>


<div class="viewcode-block" id="sbml_setDescription"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setDescription">[docs]</a><span class="k">def</span> <span class="nf">sbml_setDescription</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sets the model description as a &lt;note&gt; containing `txt` in an HTML paragraph on the model object.</span>

<span class="sd">     - *model* a libSBML model instance</span>
<span class="sd">     - *fba* a PySCeSCBM model instance</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">##  try: UseR = getuser()</span>
    <span class="c1">##  except: UseR = &#39;&#39;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">fba</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">]:</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/notes&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">+=</span> <span class="s1">&#39;&lt;html:p&gt;&lt;html:br/&gt;&lt;html:span size=&quot;small&quot;&gt;Model </span><span class="se">\&quot;</span><span class="s1">&lt;html:strong&gt;</span><span class="si">{}</span><span class="s1">&lt;/html:strong&gt;</span><span class="se">\&quot;</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) generated with &lt;html:a href=&quot;http://cbmpy.sourceforge.net&quot;&gt;CBMPy&lt;/html:a&gt; (</span><span class="si">{}</span><span class="s1">) on </span><span class="si">{}</span><span class="s1">.&lt;/html:span&gt;&lt;/html:p&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">fba</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">__version__</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">notes</span> <span class="o">+=</span> <span class="s1">&#39;&lt;html:p&gt;&lt;html:span style=&quot;font-family: Courier New,Courier,monospace;&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/html:span&gt;&lt;/html:p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">notes</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">())</span>
        <span class="n">annores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in model:&#39;</span><span class="p">,</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="sbml_setNotes3"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setNotes3">[docs]</a><span class="k">def</span> <span class="nf">sbml_setNotes3</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats the CBMPy notes as an SBML note and adds it to the SBMl object</span>

<span class="sd">     - *obj* an SBML object</span>
<span class="sd">     - *s* a string that should be added as a note</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/notes&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&lt;html:body&gt;</span><span class="si">{}</span><span class="s1">&lt;/html:body&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="sbml_getNotes"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_getNotes">[docs]</a><span class="k">def</span> <span class="nf">sbml_getNotes</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the SBML objects notes</span>

<span class="sd">    - *obj* an SBML object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">XMLNode_convertXMLNodeToString</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getNotes</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># too aggressive but efficient behaviour removed</span>
            <span class="c1">#notes = xml_stripTags(notes).strip()</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;html:body&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/html:body&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/notes&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">why</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes</span></div>

<div class="viewcode-block" id="sbml_setUnits"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setUnits">[docs]</a><span class="k">def</span> <span class="nf">sbml_setUnits</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">give_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">L3</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds units to the model:</span>

<span class="sd">    - *model* a libSBML model instance</span>
<span class="sd">    - *units* [default=None] a dictionary of units, if None default units are used</span>
<span class="sd">    - *give_default* [default=False] if true method returns the default unit dictionary</span>
<span class="sd">    - *L3* [default=True] use the L3 defaults</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">L3</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">UNIT_DICTIONARY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">UNIT_DICTIONARY_L2</span>

    <span class="k">if</span> <span class="n">give_default</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">units</span>

    <span class="k">for</span> <span class="n">un</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
        <span class="n">vdef</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createUnitDefinition</span><span class="p">()</span>
        <span class="n">vdef</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">un</span><span class="p">)</span>
        <span class="n">vdef</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">un</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">L3</span> <span class="ow">and</span> <span class="n">un</span> <span class="ow">in</span> <span class="n">MODEL_UNITS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">MODEL_UNITS</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">un</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">setTimeUnits</span><span class="p">(</span><span class="n">un</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">MODEL_UNITS</span><span class="p">[</span><span class="s1">&#39;extent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">un</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">setExtentUnits</span><span class="p">(</span><span class="n">un</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">MODEL_UNITS</span><span class="p">[</span><span class="s1">&#39;substance&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">un</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">setSubstanceUnits</span><span class="p">(</span><span class="n">un</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">un</span><span class="p">])):</span>
            <span class="n">vu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createUnit</span><span class="p">()</span>
            <span class="n">vu</span><span class="o">.</span><span class="n">setKind</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">UnitKind_forName</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">un</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="s1">&#39;kind&#39;</span><span class="p">]))</span>
            <span class="n">vu</span><span class="o">.</span><span class="n">setMultiplier</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">un</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="s1">&#39;multiplier&#39;</span><span class="p">])</span>
            <span class="n">vu</span><span class="o">.</span><span class="n">setScale</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">un</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]))</span>
            <span class="n">vu</span><span class="o">.</span><span class="n">setExponent</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">un</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="s1">&#39;exponent&#39;</span><span class="p">]))</span>
            <span class="n">vu</span><span class="o">.</span><span class="n">setOffset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="sbml_writeAnnotationsAsCOBRANote"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_writeAnnotationsAsCOBRANote">[docs]</a><span class="k">def</span> <span class="nf">sbml_writeAnnotationsAsCOBRANote</span><span class="p">(</span><span class="n">annotations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the annotations dictionary as a COBRA compatible SBML &lt;note&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annoSTR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="c1"># this is to keep COBRA happy</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">==</span> <span class="s1">&#39;subsystem&#39;</span><span class="p">:</span>
            <span class="n">Kcob</span> <span class="o">=</span> <span class="s1">&#39;SUBSYSTEM&#39;</span>
        <span class="k">elif</span> <span class="n">K</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gene_association&#39;</span><span class="p">,</span> <span class="s1">&#39;GENE_ASSOCIATION&#39;</span><span class="p">]:</span>
            <span class="n">Kcob</span> <span class="o">=</span> <span class="s1">&#39;GENE ASSOCIATION&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kcob</span> <span class="o">=</span> <span class="n">K</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annotations</span><span class="p">[</span><span class="n">K</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span>
        <span class="n">annoSTR</span> <span class="o">+=</span> <span class="s2">&quot;&lt;html:p&gt;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&lt;/html:p&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Kcob</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="n">annoSTR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">annoSTR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annoSTR</span></div>

<div class="viewcode-block" id="sbml_setSpeciesL2"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setSpeciesL2">[docs]</a><span class="k">def</span> <span class="nf">sbml_setSpeciesL2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">return_dicts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the species definitions to the SBML object:</span>

<span class="sd">     - *model* [default=&#39;&#39;] a libSBML model instance or can be None if *return_dicts* == True</span>
<span class="sd">     - *fba* a PySCeSCBM model instance</span>
<span class="sd">     - *return_dicts* [default=False] only returns the compartment and species dictionaries without updated the SBML</span>

<span class="sd">    returns:</span>

<span class="sd">     - *compartments* a dictionary of compartments (except when give *return_dicts* argument)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">compartments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">species</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compartments</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;dimensions&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">}})</span>
        <span class="c1">#print &#39;++&#39;, s.charge</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">miriam</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
        <span class="n">species</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span>
                                      <span class="s1">&#39;compartment&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span>
                                      <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                                      <span class="s1">&#39;charge&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                      <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                      <span class="s1">&#39;annotation&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                      <span class="s1">&#39;boundary&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">is_boundary</span><span class="p">,</span>
                                      <span class="s1">&#39;chemFormula&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">chemFormula</span><span class="p">,</span>
                                      <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="n">miriam</span>
                                      <span class="p">}</span>
                        <span class="p">})</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: no compartments defined adding one called </span><span class="se">\&quot;</span><span class="s1">cell</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">compartments</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cell&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;dimensions&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">}})</span>

    <span class="k">if</span> <span class="n">return_dicts</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compartments</span><span class="p">,</span> <span class="n">species</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
    <span class="c1">#keys.sort()</span>
    <span class="k">for</span> <span class="n">spe</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createSpecies</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="c1">#METAID</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="o">+</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="c1">#if not (species[spe][&#39;charge&#39;] != None or species[spe][&#39;charge&#39;] != &#39;&#39;):</span>
            <span class="c1">#s.setCharge(int(species[spe][&#39;charge&#39;]))</span>
        <span class="n">Ranno</span> <span class="o">=</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="c1">#print species[spe][&#39;charge&#39;], int(species[spe][&#39;charge&#39;])</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">setCharge</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;charge&#39;</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to set charge, L</span><span class="si">{}</span><span class="s1">V</span><span class="si">{}</span><span class="s1"> &gt; L2V1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getLevel</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
                    <span class="n">Ranno</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;CHARGE&#39;</span> <span class="p">:</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;charge&#39;</span><span class="p">]})</span>

        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setCompartment</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setCompartment</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;boundary&#39;</span><span class="p">]:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setBoundaryCondition</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#s.setConstant(True)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setBoundaryCondition</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="kc">None</span><span class="p">]:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setInitialConcentration</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
            <span class="c1">##  s.setInitialAmount(float(species[spe][&#39;value&#39;]))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setHasOnlySubstanceUnits</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">annoSTR</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#if species[spe][&#39;chemFormula&#39;] != None and species[spe][&#39;chemFormula&#39;] != &#39;&#39;:</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;chemFormula&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">Ranno</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;FORMULA&#39;</span> <span class="p">:</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;chemFormula&#39;</span><span class="p">]})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ranno</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annoSTR</span> <span class="o">=</span> <span class="n">sbml_writeAnnotationsAsCOBRANote</span><span class="p">(</span><span class="n">Ranno</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annoSTR</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nres</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">annoSTR</span><span class="p">)</span>
        <span class="c1"># this should go last</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compartments</span></div>


<div class="viewcode-block" id="sbml_setReactionsL2"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setReactionsL2">[docs]</a><span class="k">def</span> <span class="nf">sbml_setReactionsL2</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the FBA instance reactions to the SBML model</span>

<span class="sd">     - *model* an SBML model instance</span>
<span class="sd">     - *fba* a PySCeSCBM model instance</span>
<span class="sd">     - *return_dict* [default=False] if True do not add reactions to SBML document instead return a dictionary description of the reactions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SBML_LEVEL</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SBML_VERSION</span> <span class="o">=</span><span class="mi">1</span>
    <span class="n">reactions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">products</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">getStoichiometry</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">products</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reactants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">miriam</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
        <span class="n">reactions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">r</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span>
                                        <span class="s1">&#39;reactants&#39;</span> <span class="p">:</span> <span class="n">reactants</span><span class="p">,</span>
                                        <span class="s1">&#39;products&#39;</span> <span class="p">:</span> <span class="n">products</span><span class="p">,</span>
                                        <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                                        <span class="s1">&#39;reversible&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">reversible</span><span class="p">,</span>
                                        <span class="s1">&#39;exchange&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">is_exchange</span><span class="p">,</span>
                                        <span class="s1">&#39;annotation&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                        <span class="s1">&#39;compartment&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span>
                                        <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="n">miriam</span>
                                        <span class="p">}</span>
                          <span class="p">})</span>
    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reactions</span>

    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
        <span class="c1"># print &#39;Adding reaction:&#39;, reactions[rxn][&#39;id&#39;]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createReaction</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="c1">#METAID</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="o">+</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">])):</span>
            <span class="c1">#print &#39;\t&#39; + reactions[rxn][&#39;id&#39;] +&#39; has substrate: &#39; + s.name + &#39; (%s)&#39; % abs(rxn.stoichiometry[s.name])</span>
            <span class="k">if</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">getLibSBMLVersion</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">40000</span><span class="p">:</span>
                <span class="n">sref</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SpeciesReference</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sref</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SpeciesReference</span><span class="p">(</span><span class="n">SBML_LEVEL</span><span class="p">,</span> <span class="n">SBML_VERSION</span><span class="p">)</span>
                <span class="n">sref</span><span class="o">.</span><span class="n">setStoichiometry</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">sref</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1">#METAID</span>
            <span class="c1">#sref.setMetaId(&#39;%s_%s&#39; % (reactions[rxn][&#39;id&#39;], reactions[rxn][&#39;reactants&#39;][s][1]))</span>
            <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">addReactant</span><span class="p">(</span><span class="n">sref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error setting reagent&#39;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">])):</span>
            <span class="c1">#print &#39;\t&#39; + reactions[rxn][&#39;id&#39;] +&#39; has product: &#39; + p.name + &#39; (%s)&#39; % abs(rxn.stoichiometry[p.name])</span>
            <span class="k">if</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">getLibSBMLVersion</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">40000</span><span class="p">:</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SpeciesReference</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">SpeciesReference</span><span class="p">(</span><span class="n">SBML_LEVEL</span><span class="p">,</span> <span class="n">SBML_VERSION</span><span class="p">)</span>
                <span class="n">pref</span><span class="o">.</span><span class="n">setStoichiometry</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">pref</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1">#METAID</span>
            <span class="c1">#pref.setMetaId(&#39;%s_%s&#39; % (reactions[rxn][&#39;id&#39;], reactions[rxn][&#39;products&#39;][p][1]))</span>
            <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">addProduct</span><span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error setting product&#39;</span>
        <span class="n">Ranno</span> <span class="o">=</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: investigate this</span>
        <span class="c1">#if &#39;GENE_ASSOCIATION&#39; in Ranno:</span>
            <span class="c1">#Ranno.update({&#39;GENE ASSOCIATION&#39; : Ranno.pop(&#39;GENE_ASSOCIATION&#39;)})</span>
        <span class="c1">#print &#39;Ranno&#39;, Ranno</span>
        <span class="n">annoSTR</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ranno</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annoSTR</span> <span class="o">=</span> <span class="n">sbml_writeAnnotationsAsCOBRANote</span><span class="p">(</span><span class="n">Ranno</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annoSTR</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nres</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">annoSTR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nres</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">nres</span><span class="p">,</span> <span class="n">annoSTR</span><span class="p">)</span>
            <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">Ranno</span><span class="p">)</span> <span class="c1"># future compatability with L3</span>
            <span class="n">annores</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reversible&#39;</span><span class="p">]:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setReversible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setReversible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># this should go last</span>
        <span class="c1"># this may be a bug in libSBML in that setCVterm needs to come after appendAnnotation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="sbml_exportSBML2FBAModel"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_exportSBML2FBAModel">[docs]</a><span class="k">def</span> <span class="nf">sbml_exportSBML2FBAModel</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_note_body</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes an SBML model object to file. Note this is an internal SBML method use `sbml_writeSBML2FBA()` to write an FBA model:</span>

<span class="sd">     - *model* a libSBML model instance</span>
<span class="sd">     - *filename* the output filename</span>
<span class="sd">     - *directory* [default=None] by default use filename otherwise join, &lt;dir&gt;&lt;filename&gt;</span>
<span class="sd">     - *return_doc* [default=False] return the SBML document used to write the XML</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">directory</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">directory</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span> <span class="n">UseR</span> <span class="o">=</span> <span class="n">getuser</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span> <span class="n">UseR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">SBML_LEVEL</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SBML_VERSION</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#raw_input(&#39;L%sV%s&#39; % (document.getLevel(),document.getVersion()))</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">h1</span> <span class="o">+=</span> <span class="s1">&#39;&lt;!-- Created with CBMPy (&#39;</span><span class="o">+</span> <span class="n">__version__</span> <span class="o">+</span> <span class="s1">&#39;) on &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; by &#39;</span><span class="o">+</span><span class="n">UseR</span><span class="o">+</span><span class="s1">&#39; --&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">SBMLDoc</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">toSBML</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">remove_note_body</span><span class="p">:</span>
        <span class="n">SBMLDoc</span> <span class="o">=</span> <span class="n">SBMLDoc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;body xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">SBMLDoc</span> <span class="o">=</span> <span class="n">SBMLDoc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/body&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">F</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">h1</span> <span class="o">+</span> <span class="n">SBMLDoc</span><span class="p">)</span>
    <span class="n">F</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">F</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model exported as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>

<div class="viewcode-block" id="sbml_writeSBML2FBA"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_writeSBML2FBA">[docs]</a><span class="k">def</span> <span class="nf">sbml_writeSBML2FBA</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sbml_level_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an FBA model object and writes it to file as SBML L3 FBA:</span>

<span class="sd">     - *fba* an fba model object</span>
<span class="sd">     - *fname* the model will be written as XML to *fname*</span>
<span class="sd">     - *directory* [default=None] if defined it is prepended to fname</span>
<span class="sd">     - *sbml_level_version* [default=None] a tuple containing the SBML level and version e.g. (2,4) (ignored)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">##  __DEBUG__ = True</span>

    <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SBML not available ... install libSBML with Python bindings for SBML support&quot;</span>

    <span class="n">SBML_LEVEL</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SBML_VERSION</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#  create L3 as annotation</span>
    <span class="n">L3FBA</span> <span class="o">=</span> <span class="n">xml_getSBML2FBAannotation</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="s1">&#39;test_xml.xml&#39;</span><span class="p">)</span> <span class="c1"># should be None</span>

    <span class="c1"># create a model</span>
    <span class="n">SMOD</span><span class="p">,</span> <span class="n">document</span> <span class="o">=</span> <span class="n">sbml_createModelL2</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">SBML_LEVEL</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">SBML_VERSION</span><span class="p">)</span>
    <span class="n">sbml_setDescription</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">fba</span><span class="p">)</span>
    <span class="n">sbml_setUnits</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L3</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">sbml_setSpeciesL2</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">fba</span><span class="p">)</span>
    <span class="n">sbml_setCompartmentsL2</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
    <span class="n">sbml_setReactionsL2</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">SMOD</span><span class="o">.</span><span class="n">setAnnotation</span><span class="p">(</span><span class="n">L3FBA</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">sbml_exportSBML2FBAModel</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">return_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Model&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">L3FBA</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pprint</span>
        <span class="n">PP</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Units&#39;</span><span class="p">)</span>
        <span class="n">PP</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">sbml_setUnits</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">give_default</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Compartments&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">sbml_setSpeciesL2</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">return_dicts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">PP</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Species&#39;</span><span class="p">)</span>
        <span class="n">PP</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reactions&#39;</span><span class="p">)</span>
        <span class="n">PP</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">sbml_setReactionsL2</span><span class="p">(</span><span class="n">SMOD</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">FBCconnect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">metaprefix</span> <span class="o">=</span> <span class="s1">&#39;meta_&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sbml</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sbmllevel</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">sbmlversion</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">groupsversion</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sbmlns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fbc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fbcversion</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fbcstrict</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">maxobjname</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span> <span class="s1">&#39;maximise&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
    <span class="n">minobjname</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;minimize&#39;</span><span class="p">,</span><span class="s1">&#39;minimise&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
    <span class="n">GROUPS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">groupList</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fbc_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fbc_strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect SBML Packages</span>

<span class="sd">         - *fbc_version* [default=1] fbc version</span>
<span class="sd">         - *fbc_strict* [default=True] if using FBC V2 set the strict flag</span>
<span class="sd">         - *enable_groups* [default=False] use the Groups package if possible</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ERROR: libSBML required for SBML support&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span> <span class="o">=</span> <span class="n">libsbml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbcversion</span> <span class="o">=</span> <span class="n">fbc_version</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkPackageRegistry</span><span class="p">(</span><span class="s1">&#39;fbc&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SBML Level 3 FBC package required!</span><span class="se">\n</span><span class="s1">(http://sbml.org/Documents/Specifications/SBML_Level_3/Packages/Flux_Balance_Constraints_</span><span class="si">%28f</span><span class="s1">lux%29)&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sbmlns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">SBMLNamespaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbmllevel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbmlversion</span><span class="p">,</span> <span class="s1">&#39;fbc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbcversion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbmlns</span><span class="o">.</span><span class="n">addNamespace</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">enable_groups</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkPackageRegistry</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sbmlns</span><span class="o">.</span><span class="n">addNamespace</span><span class="p">(</span><span class="s2">&quot;http://www.sbml.org/sbml/level3/version1/groups/version1&quot;</span><span class="p">,</span> <span class="s2">&quot;groups&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GROUPS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GROUPS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">SBMLDocument</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbmlns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">setPackageRequired</span><span class="p">(</span><span class="s1">&#39;fbc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">createModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s2">&quot;fbc&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GROUPS_AVAILABLE</span><span class="p">:</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">setPackageRequired</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: Groups initialisation error, not enabled.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">GROUPS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">fbc_strict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fbcstrict</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span><span class="o">.</span><span class="n">setStrict</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SBML Level 3 FBC package required!</span><span class="se">\n</span><span class="s1">(http://sbml.org/Documents/Specifications/SBML_Level_3/Packages/Flux_Balance_Constraints_</span><span class="si">%28f</span><span class="s1">lux%29)&#39;</span>

    <span class="k">def</span> <span class="nf">_checkPackageRegistry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">SBMLExtensionRegistry</span><span class="o">.</span><span class="n">getNumRegisteredPackages</span><span class="p">()):</span>
            <span class="n">pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">SBMLExtensionRegistry</span><span class="o">.</span><span class="n">getRegisteredPackageName</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">pkgs</span>


    <span class="k">def</span> <span class="nf">createGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a group to the SBML model.</span>

<span class="sd">         - *grp* the cbmpy group object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>






    <span class="k">def</span> <span class="nf">createGroupLegacy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to add a group to the model if (assuming the groups package is available).</span>

<span class="sd">         - *gid* the group name</span>
<span class="sd">         - *groups* a list of strings that refer to model SId&#39;s</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">gl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getListOfGroups</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gl</span> <span class="o">=</span> <span class="p">[</span><span class="n">g_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="n">gl</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gl</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Group </span><span class="si">{}</span><span class="s1"> exists appending items&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span>
            <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">getGroup</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Group </span><span class="si">{}</span><span class="s1"> does not exist creating&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span>
            <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">createGroup</span><span class="p">()</span>
            <span class="n">G</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m_</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">createMember</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">setIdRef</span><span class="p">(</span><span class="n">m_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">out</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: cannot add </span><span class="si">{}</span><span class="s1"> to group </span><span class="si">{}</span><span class="s1"> as it is not a valid model id&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m_</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">createFluxBoundV1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">FB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span><span class="o">.</span><span class="n">createFluxBound</span><span class="p">()</span>
        <span class="n">FB</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">FB</span><span class="o">.</span><span class="n">setReaction</span><span class="p">(</span><span class="n">reaction</span><span class="p">)</span>
        <span class="n">FB</span><span class="o">.</span><span class="n">setOperation</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cannot interpret bound </span><span class="si">%s</span><span class="s2"> with value </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">createObjective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">osense</span><span class="p">,</span> <span class="n">flux_objs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and add the FBC Objective function</span>

<span class="sd">         - *oid* objective id</span>
<span class="sd">         - *osense* objective sense</span>
<span class="sd">         - *flux_objs* [(reaction, coefficient)]</span>
<span class="sd">         - *name*</span>
<span class="sd">         - *active*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span><span class="o">.</span><span class="n">createObjective</span><span class="p">()</span>
        <span class="n">O</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">O</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osense</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxobjname</span><span class="p">:</span>
            <span class="n">osense</span> <span class="o">=</span> <span class="s1">&#39;maximize&#39;</span>
        <span class="k">elif</span> <span class="n">osense</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minobjname</span><span class="p">:</span>
            <span class="n">osense</span> <span class="o">=</span> <span class="s1">&#39;minimize&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown objective sense: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">osense</span><span class="p">)</span>
        <span class="n">O</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">osense</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span><span class="o">.</span><span class="n">setActiveObjectiveId</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fo_</span> <span class="ow">in</span> <span class="n">flux_objs</span><span class="p">:</span>
            <span class="n">FO</span> <span class="o">=</span> <span class="n">O</span><span class="o">.</span><span class="n">createFluxObjective</span><span class="p">()</span>
            <span class="n">FO</span><span class="o">.</span><span class="n">setReaction</span><span class="p">(</span><span class="n">fo_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">FO</span><span class="o">.</span><span class="n">setCoefficient</span><span class="p">(</span><span class="n">fo_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">createGeneAssociationV1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">assoc</span><span class="p">,</span> <span class="n">gprid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a gene association for a specified reaction and an association string</span>

<span class="sd">         - *rid* a reaction id</span>
<span class="sd">         - *assoc* the association string e.g.(b0698 and b0697) or (b0696)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">GPR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span><span class="o">.</span><span class="n">createGeneAssociation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gprid</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># try this: get rid of invalid symbols in GPRid</span>

            <span class="n">GPR</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_gpra&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">GPR</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">gprid</span><span class="p">)</span>

        <span class="n">GA</span> <span class="o">=</span> <span class="n">GPR</span><span class="o">.</span><span class="n">createAssociation</span><span class="p">()</span>
        <span class="n">ass</span> <span class="o">=</span> <span class="n">GA</span><span class="o">.</span><span class="n">parseInfixAssociation</span><span class="p">(</span><span class="n">assoc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ass</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret1</span> <span class="o">=</span> <span class="n">GPR</span><span class="o">.</span><span class="n">setAssociation</span><span class="p">(</span><span class="n">ass</span><span class="p">)</span>
            <span class="n">ret2</span> <span class="o">=</span> <span class="n">GPR</span><span class="o">.</span><span class="n">setReaction</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ret2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ret0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ret0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Incompatible gene label: </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">.(</span><span class="si">{}</span><span class="s1">) only dots and underscores are currently allowed in gene labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">assoc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GPR</span>


    <span class="k">def</span> <span class="nf">writeToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">writeSBMLToFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_cleanUP_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbmlns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GROUPS_AVAILABLE</span> <span class="o">=</span> <span class="kc">None</span>



<span class="c1">#def sbml_writeAnnotations(annotations):</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#Writes the annotations dictionary as a BiGG compatible SBML &lt;note&gt; and a new style SBML parameter annotation</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#raise NotImplemented</span>
    <span class="c1">#annoSTR = &#39;&#39;</span>
    <span class="c1">#for K in annotations:</span>
        <span class="c1">#val = str(annotations[K]).replace(&#39;&lt;&#39;,&#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;,&#39;&amp;gt;&#39;)</span>
        <span class="c1">###  val = str(annotations[K]).replace(&quot;&#39;&quot;,&#39;&#39;).replace(&#39;&lt;&#39;,&#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;,&#39;&amp;gt;&#39;)</span>
        <span class="c1">#annoSTR += &quot;&lt;html:p&gt;%s: %s&lt;/html:p&gt;\n&quot; % (K, val)</span>
    <span class="c1">###  print annoSTR</span>
    <span class="c1">#return annoSTR</span>


<span class="k">class</span> <span class="nc">CBMtoSBML3</span><span class="p">(</span><span class="n">FBCconnect</span><span class="p">):</span>
    <span class="n">fba</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bound_registry</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parameter_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parameter_cntr</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">fbc_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fbc_strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a CBM model to SBML level 3 with FBC</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CBMtoSBML3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fbc_version</span><span class="p">,</span> <span class="n">fbc_strict</span><span class="p">,</span> <span class="n">enable_groups</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fba</span> <span class="o">=</span> <span class="n">fba</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mid0</span> <span class="o">=</span> <span class="s1">&#39;CBMPY_Model&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mid0</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>

        <span class="n">mid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">mid0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
                <span class="n">mid</span> <span class="o">+=</span> <span class="n">l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mid</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="s1">&#39;MODEL_&#39;</span> <span class="o">+</span> <span class="n">mid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span> <span class="o">+</span> <span class="n">mid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addModelAnnotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fba</span><span class="p">):</span>
        <span class="c1"># this should go last</span>
        <span class="k">if</span> <span class="n">fba</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">miriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addModelHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If they exist add CBM model history information to SBML model</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sbmh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">ModelHistory</span><span class="p">()</span>
        <span class="n">GO</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">DATE_CREATED</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">sbmh</span><span class="o">.</span><span class="n">setCreatedDate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">DATE_CREATED</span><span class="p">))</span>
            <span class="n">GO</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">DATE_MODIFIED</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">sbmh</span><span class="o">.</span><span class="n">setModifiedDate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">DATE_MODIFIED</span><span class="p">))</span>
            <span class="n">GO</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">:</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">ModelCreator</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;firstname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">C</span><span class="o">.</span><span class="n">setGivenName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;firstname&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;lastname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">C</span><span class="o">.</span><span class="n">setFamilyName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;lastname&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;organisation&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">C</span><span class="o">.</span><span class="n">setOrganisation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;organisation&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">C</span><span class="o">.</span><span class="n">setEmail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">MODEL_CREATORS</span><span class="p">[</span><span class="n">c_</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
                <span class="n">sbmh</span><span class="o">.</span><span class="n">addCreator</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">C</span>
            <span class="n">GO</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">GO</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setModelHistory</span><span class="p">(</span><span class="n">sbmh</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">sbmh</span>

    <span class="k">def</span> <span class="nf">addBoundsV2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compress_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add FBC V2 style fluxbounds to model</span>

<span class="sd">         - *compress_bounds* [default=False] enable parameter compression</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compress_bounds</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: V2 bounds compression enabled&#39;</span><span class="p">)</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">shared_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">r_</span><span class="o">.</span><span class="n">getLowerBound</span><span class="p">(),</span> <span class="mi">12</span><span class="p">)</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">r_</span><span class="o">.</span><span class="n">getUpperBound</span><span class="p">(),</span> <span class="mi">12</span><span class="p">)</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">r_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
                <span class="n">bounds</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shared_values</span><span class="p">:</span>
                    <span class="n">shared_values</span><span class="p">[</span><span class="n">lb</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_lb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shared_values</span><span class="p">[</span><span class="n">lb</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_lb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ub</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shared_values</span><span class="p">:</span>
                    <span class="n">shared_values</span><span class="p">[</span><span class="n">ub</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_ub&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shared_values</span><span class="p">[</span><span class="n">ub</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_ub&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rid</span><span class="p">))</span>


            <span class="n">bnd_pars</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">shared_values</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="s1">&#39;bnd_par</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cntr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createFbParameterSharedV2</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">bnd_pars</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span>
                <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">b_</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">b_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">b_</span><span class="p">][</span><span class="s1">&#39;lb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnd_pars</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="n">b_</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">b_</span><span class="p">][</span><span class="s1">&#39;ub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnd_pars</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="n">b_</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Add parameter has detected duplicate reaction: </span><span class="si">{}</span><span class="s1"> (CBXML:1621)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bnd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">flux_bounds</span><span class="p">:</span>
                <span class="n">bid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createFbParameterV2</span><span class="p">(</span><span class="n">bnd</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">bnd</span><span class="o">.</span><span class="n">getReactionId</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">btype</span> <span class="o">=</span> <span class="n">bnd</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">btype</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;lb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bid</span>
                <span class="k">elif</span> <span class="n">btype</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: strange flux bound assigment type error (CBXML:1635)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addBoundsV1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autofix</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the CBM fluxbounds to SBML</span>

<span class="sd">         - *autofix* convert &#39;&lt; &gt;&#39; to &#39;&lt;= &gt;=&#39; default = False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bound_registry</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fb_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">flux_bounds</span><span class="p">:</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">fb_</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">fb_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fb_</span><span class="o">.</span><span class="n">reaction</span><span class="p">,</span> <span class="n">fb_</span><span class="o">.</span><span class="n">is_bound</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_registry</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bound_registry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
                <span class="n">operation</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">autofix</span> <span class="ow">and</span> <span class="n">fb_</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;less&#39;</span><span class="p">:</span>
                    <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39;lessEqual&#39;</span>
                <span class="k">elif</span> <span class="n">autofix</span> <span class="ow">and</span> <span class="n">fb_</span><span class="o">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;greater&#39;</span><span class="p">:</span>
                    <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39;greaterEqual&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">operation</span> <span class="o">=</span> <span class="n">fb_</span><span class="o">.</span><span class="n">operation</span>
                    <span class="c1">#print &#39;Illegal operation in bound %s: %s&#39; % (fb_.getId(), fb_.operation)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createFluxBoundV1</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">fb_</span><span class="o">.</span><span class="n">reaction</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">fb_</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bound </span><span class="si">%s</span><span class="s1"> already exists, skipping ...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">addObjectives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the CBM objective function to SBML</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ob_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
            <span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">ob_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">getActiveObjective</span><span class="p">()</span><span class="o">.</span><span class="n">getId</span><span class="p">():</span>
                <span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">flux_objs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">o2</span><span class="o">.</span><span class="n">reaction</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">o2</span><span class="o">.</span><span class="n">coefficient</span><span class="p">))</span> <span class="k">for</span> <span class="n">o2</span> <span class="ow">in</span> <span class="n">ob_</span><span class="o">.</span><span class="n">fluxObjectives</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createObjective</span><span class="p">(</span><span class="n">ob_</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">ob_</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">flux_objs</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addGenesV2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parse_from_annotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotation_key</span><span class="o">=</span><span class="s1">&#39;GENE ASSOCIATION&#39;</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create genes and add to SBML models (FBC V2)</span>

<span class="sd">         - *parse_from_annotation* [default=False] if the gpr_assoc list is empty e.g. the GPR associations have</span>
<span class="sd">            not been parsed enabling this will do so.</span>
<span class="sd">         - *annotation_key* [default=&#39;GENE ASSOCIATION&#39;] the key to use for the gene association if parse_from_annotation is True</span>
<span class="sd">           by default it will try one of GENE ASSOCIATION, GENE_ASSOCIATION, gene_association, gene association.</span>
<span class="sd">         - *add_cbmpy_anno* [default=True] add PySCeS CBMPy annotation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">gpr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">parse_from_annotation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">createGeneAssociationsFromAnnotations</span><span class="p">(</span><span class="n">annotation_key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">genes</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span><span class="o">.</span><span class="n">createGeneProduct</span><span class="p">()</span>

            <span class="n">G</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">formatSbmlId</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">formatSbmlId</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">getMetaId</span><span class="p">()))</span>
            <span class="n">G</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">getLabel</span><span class="p">())</span>
            <span class="n">sboterm</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sboterm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sboterm</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sboterm</span><span class="p">))</span>

            <span class="n">notes</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">add_cbmpy_anno</span><span class="p">:</span>
                    <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="n">annores</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in Gene&#39;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># last blah blah</span>
                <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">(),</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addGeneProteinAssociationsV1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parse_from_annotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotation_key</span><span class="o">=</span><span class="s1">&#39;GENE ASSOCIATION&#39;</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the CBM geneProtein associations to SBML from the gpr_assoc list (FBC V1)</span>

<span class="sd">         - *parse_from_annotation* [default=False] if the gpr_assoc list is empty e.g. the GPR associations have</span>
<span class="sd">            not been parsed enabling this will do so.</span>
<span class="sd">         - *annotation_key* [default=&#39;GENE ASSOCIATION&#39;] the key to use for the gene association if parse_from_annotation is True</span>
<span class="sd">           by default it will try one of GENE ASSOCIATION, GENE_ASSOCIATION, gene_association, gene association.</span>
<span class="sd">         - *add_cbmpy_anno* add PySCeS CBMPy annotation (still to be implemented)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">gpr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">parse_from_annotation</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;addGeneProteinAssociationsV1 is generating gpr</span><span class="se">\&#39;</span><span class="s1">s from annotation strings&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">createGeneAssociationsFromAnnotations</span><span class="p">(</span><span class="n">annotation_key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">gpr</span><span class="p">:</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">g_</span><span class="o">.</span><span class="n">getProtein</span><span class="p">()</span>
            <span class="n">assoc</span> <span class="o">=</span> <span class="n">g_</span><span class="o">.</span><span class="n">getAssociationStr</span><span class="p">(</span><span class="n">use_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rid</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rid</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">assoc</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">assoc</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">GPR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createGeneAssociationV1</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">assoc</span><span class="p">,</span> <span class="n">gprid</span><span class="o">=</span><span class="n">g_</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
                    <span class="n">gprnotes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">ge_</span> <span class="ow">in</span> <span class="n">g_</span><span class="o">.</span><span class="n">getGeneIds</span><span class="p">():</span>
                        <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fba</span><span class="o">.</span><span class="n">getGene</span><span class="p">(</span><span class="n">ge_</span><span class="p">)</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">gprnotes</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">gprnotes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">GPR</span><span class="p">,</span> <span class="n">gprnotes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Skipping GPR association: </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;\n\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">--&gt; </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g_</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">rid</span><span class="p">,</span> <span class="n">assoc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">createParParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a generic SBML parameter from a CBMPy parameter</span>

<span class="sd">         - *param* a CBMPy parameter object</span>
<span class="sd">         - *add_cbmpy_anno* [default=True] add annotation to SBML object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&#39;createParParameter&#39;, param.getId())</span>
        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">createParameter</span><span class="p">()</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="s1">&#39;meta_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_cbmpy_anno</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">par</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">annores</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">miriam</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">miriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createFbParameterV2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bnd</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create SBML V2 flux bound parameters for reaction</span>

<span class="sd">         - *bnd* object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&#39;createFbParameterV2&#39;, bnd.getId())</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">createParameter</span><span class="p">()</span>
        <span class="n">bid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bnd</span><span class="o">.</span><span class="n">getReactionId</span><span class="p">(),</span> <span class="n">bnd</span><span class="o">.</span><span class="n">getType</span><span class="p">())</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">bid</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="s1">&#39;meta_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bid</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">bnd</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">bnd</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="s1">&#39;SBO:0000625&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_cbmpy_anno</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bnd</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">bnd</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">annores</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in bound:&#39;</span><span class="p">,</span> <span class="n">bid</span><span class="p">)</span>
                    <span class="c1">#print(bnd.annotation, &#39;\n&#39;)</span>
            <span class="k">if</span> <span class="n">bnd</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">miriam</span> <span class="o">=</span> <span class="n">bnd</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">miriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bid</span>

    <span class="k">def</span> <span class="nf">createFbParameterSharedV2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create SBML V2 flux bound parameters for reaction</span>

<span class="sd">         - *value* parameter value</span>
<span class="sd">         - *pid* optional parameter id</span>

<span class="sd">         returns parameter id</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">createParameter</span><span class="p">()</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="s1">&#39;meta_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="s1">&#39;SBO:0000625&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_cleanUP_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fbc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbmlns</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="sbml_writeKeyValueDataAnnotation"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_writeKeyValueDataAnnotation">[docs]</a><span class="k">def</span> <span class="nf">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">annotations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the key:value annotations as a KeyValueData annotation (http://pysces.sourceforge.net/KeyValueData)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">annoSTR</span> <span class="o">=</span> <span class="s1">&#39;&lt;listOfKeyValueData xmlns=&quot;http://pysces.sourceforge.net/KeyValueData&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">Ktype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Kval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#if type(annotations[K]) == bool:</span>
            <span class="c1">#Ktype = &#39;boolean&#39;</span>
        <span class="c1">#elif type(annotations[K]) == int or type(annotations[K]) == long:</span>
            <span class="c1">#Ktype = &#39;integer&#39;</span>
        <span class="c1">#elif type(annotations[K]) == float or type(annotations[K]) == numpy.float or type(annotations[K]) == numpy.double:</span>
            <span class="c1">#Ktype = &#39;double&#39;</span>
        <span class="c1">#else:</span>
            <span class="c1">#Ktype = &#39;string&#39;</span>
        <span class="k">if</span> <span class="n">annotations</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">annotations</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Kval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1">##elif isinstance(annotations[K], list):</span>
            <span class="c1">###if len(annotations[K]) == 1:</span>
                <span class="c1">###Kval = annotations[K][0]</span>
            <span class="c1">###else:</span>
                <span class="c1">#### this may be a bit dodgy but wtf let&#39;s run with it</span>
                <span class="c1">###Kval = [&#39;&amp;apos;{}&amp;apos;&#39;.format(str(v).strip()) for v in annotations[K]]</span>
                <span class="c1">###Kval = &#39;[&#39;+&#39;, &#39;.join(map(str, Kval))+&#39;]&#39;</span>
            <span class="c1">##Kval = cgi.escape(str(annotations[K]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kval</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">annotations</span><span class="p">[</span><span class="n">K</span><span class="p">]))</span>

        <span class="c1"># fix the key to be sid compatible</span>
        <span class="c1">## removed temporarily, no reason to be an sid</span>
        <span class="c1">#Kfix = &#39;&#39;</span>
        <span class="c1">#for l in K:</span>
            <span class="c1">#if l.isalnum():</span>
                <span class="c1">#Kfix += l</span>
            <span class="c1">#else:</span>
                <span class="c1">#Kfix += &#39;_&#39;</span>

        <span class="c1">## removed temporarily, no reason to be an sid</span>
        <span class="c1">#if not Kfix[0].isalpha():</span>
            <span class="c1">#Kfix = &#39;id_&#39; + Kfix</span>
        <span class="c1">## taken out for now</span>
        <span class="c1">#Kfix = Kfix.lower()</span>
        <span class="n">Kfix</span> <span class="o">=</span> <span class="n">K</span>

        <span class="c1">#annoSTR += &#39; &lt;data id=&quot;%s&quot; type=&quot;%s&quot; value=&quot;%s&quot;/&gt;\n&#39; % (Kfix, Ktype, Kval)</span>
        <span class="n">annoSTR</span> <span class="o">+=</span> <span class="s1">&#39; &lt;data id=&quot;</span><span class="si">{}</span><span class="s1">&quot; value=&quot;</span><span class="si">{}</span><span class="s1">&quot;/&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Kfix</span><span class="p">,</span> <span class="n">Kval</span><span class="p">)</span>
    <span class="n">annoSTR</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/listOfKeyValueData&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="c1">#print annoSTR</span>
    <span class="k">return</span> <span class="n">annoSTR</span></div>

<span class="n">RE_loKVD1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&lt;data.*?/&gt;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">RE_loKVD1_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;id=&quot;.*?&quot;&#39;</span><span class="p">)</span>
<span class="c1">#RE_loKVD1_type = re.compile(&#39;type=&quot;.*?&quot;&#39;)</span>
<span class="n">RE_loKVD1_value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;value=&quot;.*?&quot;&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="sbml_readKeyValueDataAnnotation"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_readKeyValueDataAnnotation">[docs]</a><span class="k">def</span> <span class="nf">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">annotations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads KeyValueData annotation (http://pysces.sourceforge.net/KeyValueData) and returns a dictionary of key:value pairs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kvout</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;&lt;listOfKeyValueData xmlns=&quot;http://pysces.sourceforge.net/KeyValueData&quot;&gt;&#39;</span> <span class="ow">in</span>  <span class="n">annotations</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">RE_loKVD1</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">D_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">RE_loKVD1_id</span><span class="p">,</span> <span class="n">D_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#ptype = re.search(RE_loKVD1_type, D_)</span>
            <span class="c1">#if ptype != None:</span>
                <span class="c1">#ptype = ptype.group(0).split(&#39;=&#39;)[1].strip()[1:-1]</span>
            <span class="n">pvalue</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">RE_loKVD1_value</span><span class="p">,</span> <span class="n">D_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pvalue</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pvalue</span> <span class="o">=</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pvalue</span> <span class="o">=</span> <span class="n">__tagStripper__</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pvalue</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
                        <span class="k">pass</span>

            <span class="n">kvout</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue</span>
    <span class="k">return</span> <span class="n">kvout</span></div>

<div class="viewcode-block" id="sbml_setSpeciesL3"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setSpeciesL3">[docs]</a><span class="k">def</span> <span class="nf">sbml_setSpeciesL3</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">return_dicts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_cobra_anno</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">substance_units</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the species definitions to the SBML object:</span>

<span class="sd">     - *model* and SBML model instance or can be None if *return_dicts* == True</span>
<span class="sd">     - *fba* a PySCeSCBM model instance</span>
<span class="sd">     - *return_dicts* [default=False] only returns the compartment and species dictionaries without updating the SBML</span>
<span class="sd">     - *add_cbmpy_anno* [default=True] add CBMPy KeyValueData annotation. Replaces &lt;notes&gt;</span>
<span class="sd">     - *add_cobra_anno* [default=False] add COBRA &lt;notes&gt; annotation</span>
<span class="sd">     - *substance_units* [default=True] defines the species in amounts rather than concentrations (necessary for default mmol/gdw.h)</span>

<span class="sd">    returns:</span>

<span class="sd">     - *compartments* a dictionary of compartments (except when given *return_dicts* argument)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">compartments</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getCompartmentIds</span><span class="p">()</span>

    <span class="n">species</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">USE_DEFAULT_COMPARTMENT</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">DEFAULT_COMPARTMENT</span> <span class="o">=</span> <span class="s1">&#39;Cell&#39;</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">USE_DEFAULT_COMPARTMENT</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="o">=</span> <span class="n">DEFAULT_COMPARTMENT</span>
            <span class="k">if</span> <span class="n">DEFAULT_COMPARTMENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Species &quot;</span><span class="si">{}</span><span class="s1">&quot; has no compartment, creating default &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">DEFAULT_COMPARTMENT</span><span class="p">))</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Compartment</span><span class="p">(</span><span class="n">DEFAULT_COMPARTMENT</span><span class="p">,</span> <span class="n">DEFAULT_COMPARTMENT</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">C</span><span class="o">.</span><span class="n">setAnnotation</span><span class="p">(</span><span class="s1">&#39;CBMPy_info&#39;</span><span class="p">,</span> <span class="s1">&#39;created by SBML writer&#39;</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">setAnnotation</span><span class="p">(</span><span class="s1">&#39;CBMPy_info&#39;</span><span class="p">,</span> <span class="s1">&#39;compartment added by SBML writer&#39;</span><span class="p">)</span>
                <span class="n">fba</span><span class="o">.</span><span class="n">addCompartment</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
                <span class="n">compartments</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getCompartmentIds</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Compartment &quot;</span><span class="si">{}</span><span class="s1">&quot; used by species &quot;</span><span class="si">{}</span><span class="s1">&quot; is not defined, creating.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Compartment</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">C</span><span class="o">.</span><span class="n">setAnnotation</span><span class="p">(</span><span class="s1">&#39;CBMPy_info&#39;</span><span class="p">,</span> <span class="s1">&#39;created by SBML writer&#39;</span><span class="p">)</span>
            <span class="n">fba</span><span class="o">.</span><span class="n">addCompartment</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
            <span class="n">compartments</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getCompartmentIds</span><span class="p">()</span>
        <span class="c1">#print &#39;++&#39;, s.charge</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">miriam</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
        <span class="n">species</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span>
                                      <span class="s1">&#39;compartment&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span>
                                      <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                                      <span class="s1">&#39;charge&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                      <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                      <span class="s1">&#39;annotation&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                      <span class="s1">&#39;boundary&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">is_boundary</span><span class="p">,</span>
                                      <span class="s1">&#39;chemFormula&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">chemFormula</span><span class="p">,</span>
                                      <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="n">miriam</span><span class="p">,</span>
                                      <span class="s1">&#39;sboterm&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">(),</span>
                                      <span class="s1">&#39;notes&#39;</span> <span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span>
                                      <span class="p">}</span>
                        <span class="p">})</span>


    <span class="k">if</span> <span class="n">return_dicts</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compartments</span><span class="p">,</span> <span class="n">species</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
    <span class="c1">#keys.sort()</span>

    <span class="k">for</span> <span class="n">spe</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">createSpecies</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="c1">#METAID</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="o">+</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="c1"># in theory species are constant at whatever level it is set dX/dT == 0 also there is no way to change them</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#TODO (201209) think about this</span>
        <span class="c1">#if not (species[spe][&#39;charge&#39;] != None or species[spe][&#39;charge&#39;] != &#39;&#39;):</span>
            <span class="c1">#s.setCharge(int(species[spe][&#39;charge&#39;]))</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span> <span class="c1"># TODO this needs to be considered - bgoli</span>
            <span class="c1">#print species[spe][&#39;charge&#39;], int(species[spe][&#39;charge&#39;])</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s1">&#39;fbc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setCharge</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;charge&#39;</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to set charge for species: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;chemFormula&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s1">&#39;fbc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setChemicalFormula</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;chemFormula&#39;</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to set chemFormula for species: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>


        <span class="n">s</span><span class="o">.</span><span class="n">setCompartment</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;boundary&#39;</span><span class="p">]:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setBoundaryCondition</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#s.setConstant(True)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setBoundaryCondition</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1">#print species[spe][&#39;value&#39;], type(species[spe][&#39;value&#39;])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="kc">None</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">substance_units</span><span class="p">:</span>
                <span class="c1"># set the species to be in amounts or concentrations default is amounts for mmol/gdw.h</span>
                <span class="n">s</span><span class="o">.</span><span class="n">setInitialAmount</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">setInitialConcentration</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setHasOnlySubstanceUnits</span><span class="p">(</span><span class="n">substance_units</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">add_cbmpy_anno</span><span class="p">:</span>
                <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">])</span>
                <span class="n">annores</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in reaction:&#39;</span><span class="p">,</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_cobra_anno</span><span class="p">:</span>
                <span class="n">annoSTR</span> <span class="o">=</span> <span class="n">sbml_writeAnnotationsAsCOBRANote</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">])</span> <span class="c1">#GOOD RIDDANCE</span>
                <span class="k">if</span> <span class="n">annoSTR</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">annoSTR</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span>  <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;sboterm&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;sboterm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;sboterm&#39;</span><span class="p">]))</span>
        <span class="k">if</span>  <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">species</span><span class="p">[</span><span class="n">spe</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="sbml_setReactionsL3Fbc"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setReactionsL3Fbc">[docs]</a><span class="k">def</span> <span class="nf">sbml_setReactionsL3Fbc</span><span class="p">(</span><span class="n">fbcmod</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_cobra_anno</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fbc_version</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the FBA instance reactions to the SBML model</span>

<span class="sd">     - *fbcmod* a CBM2SBML instance</span>
<span class="sd">     - *return_dict* [default=False] if True do not add reactions to SBML document instead return a dictionary description of the reactions</span>
<span class="sd">     - *add_cbmpy_anno* [default=True] add CBMPy KeyValueData annotation. Replaces &lt;notes&gt;</span>
<span class="sd">     - *add_cobra_anno* [default=False] add COBRA &lt;notes&gt; annotation</span>
<span class="sd">     - *fbc_version* [default=1] writes either FBC v1 (2013) or v2 (2015)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fba</span> <span class="o">=</span> <span class="n">fbcmod</span><span class="o">.</span><span class="n">fba</span>
    <span class="n">gpr_reaction_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gpr</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">gpr</span><span class="p">:</span>
        <span class="n">gpr_reaction_map</span><span class="p">[</span><span class="n">gpr</span><span class="o">.</span><span class="n">getProtein</span><span class="p">()]</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
    <span class="c1">#print(gpr_reaction_map)</span>

    <span class="n">reactions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">products</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">getStoichiometry</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">products</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reactants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">miriam</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
        <span class="n">reactions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">r</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span>
                                        <span class="s1">&#39;reactants&#39;</span> <span class="p">:</span> <span class="n">reactants</span><span class="p">,</span>
                                        <span class="s1">&#39;products&#39;</span> <span class="p">:</span> <span class="n">products</span><span class="p">,</span>
                                        <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                                        <span class="s1">&#39;reversible&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">reversible</span><span class="p">,</span>
                                        <span class="s1">&#39;exchange&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">is_exchange</span><span class="p">,</span>
                                        <span class="s1">&#39;annotation&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getAnnotations</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                        <span class="s1">&#39;compartment&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">compartment</span><span class="p">,</span>
                                        <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="n">miriam</span><span class="p">,</span>
                                        <span class="s1">&#39;notes&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getNotes</span><span class="p">(),</span>
                                        <span class="s1">&#39;sboterm&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">(),</span>
                                        <span class="s1">&#39;modifiers&#39;</span> <span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">_modifiers_</span>
                                        <span class="p">}</span>
                          <span class="p">})</span>
    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reactions</span>

    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
        <span class="c1"># print &#39;Adding reaction:&#39;, reactions[rxn][&#39;id&#39;]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">fbcmod</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">createReaction</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">FB</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s1">&#39;fbc&#39;</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="c1">#METAID</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="o">+</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setFast</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">])):</span>
            <span class="n">sref</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">createReactant</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fbcmod</span><span class="o">.</span><span class="n">fbcstrict</span><span class="p">:</span>
                <span class="n">sref</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sref</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sref</span><span class="o">.</span><span class="n">setStoichiometry</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">sref</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reactants&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">])):</span>
            <span class="n">pref</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">createProduct</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fbcmod</span><span class="o">.</span><span class="n">fbcstrict</span><span class="p">:</span>
                <span class="n">pref</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pref</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pref</span><span class="o">.</span><span class="n">setStoichiometry</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">pref</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;products&#39;</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">add_cbmpy_anno</span><span class="p">:</span>
                <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">])</span>
                <span class="n">annores</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in reaction&#39;</span><span class="p">,</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_cobra_anno</span><span class="p">:</span>
                <span class="n">annoSTR</span> <span class="o">=</span> <span class="n">sbml_writeAnnotationsAsCOBRANote</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">])</span> <span class="c1">#GOOD RIDDANCE</span>
                <span class="k">if</span> <span class="n">annoSTR</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nres</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">annoSTR</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nres</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">nres</span><span class="p">,</span> <span class="n">annoSTR</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;reversible&#39;</span><span class="p">]:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setReversible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setReversible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setCompartment</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;sboterm&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;sboterm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;sboterm&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;modifiers&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mo_</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;modifiers&#39;</span><span class="p">]:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">addModifier</span><span class="p">(</span><span class="n">fbcmod</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">mo_</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">setLowerFluxBound</span><span class="p">(</span><span class="n">fbcmod</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;lb&#39;</span><span class="p">])</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">setUpperFluxBound</span><span class="p">(</span><span class="n">fbcmod</span><span class="o">.</span><span class="n">parameter_map</span><span class="p">[</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;ub&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">gpr_reaction_map</span><span class="p">:</span>
                <span class="n">GPR</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getGPRassociation</span><span class="p">(</span><span class="n">gpr_reaction_map</span><span class="p">[</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]])</span>
                <span class="n">sbgpr</span> <span class="o">=</span> <span class="n">FB</span><span class="o">.</span><span class="n">createGeneProductAssociation</span><span class="p">()</span>
                <span class="n">sbgpr</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">GPR</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">GPR</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sbgpr</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">GPR</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="c1"># TODO: once I have switched FBCV1 to trees then this can go into operation</span>
                <span class="c1">#sbml_createAssociationFromAST(ast.parse(GPR.getAssociationStr()).body[0], sbgpr)</span>
                <span class="n">sbml_createAssociationFromTreeV2</span><span class="p">(</span><span class="n">GPR</span><span class="o">.</span><span class="n">getTree</span><span class="p">(),</span> <span class="n">sbgpr</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GPR</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">add_cbmpy_anno</span><span class="p">:</span>
                        <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">GPR</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                        <span class="n">annores</span> <span class="o">=</span> <span class="n">sbgpr</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in reaction GPR association&#39;</span><span class="p">,</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">GPR</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">sbgpr</span><span class="p">,</span> <span class="n">GPR</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">(),</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">reactions</span><span class="p">[</span><span class="n">rxn</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="sbml_setGroupsL3"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setGroupsL3">[docs]</a><span class="k">def</span> <span class="nf">sbml_setGroupsL3</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fba</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add groups to the SBML model</span>

<span class="sd">     - *cs* a CBMLtoSBML instance</span>
<span class="sd">     - *fba* a CBMPy model instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cs</span><span class="o">.</span><span class="n">GROUPS_AVAILABLE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: Groups package not available.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">gids</span> <span class="o">=</span> <span class="n">fba</span><span class="o">.</span><span class="n">getGroupIds</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">fba</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
        <span class="c1">#global g</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">createGroup</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">getName</span><span class="p">()))</span>
        <span class="n">metaid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getMetaId</span><span class="p">()</span>
        <span class="c1">#print(grp.getId(), metaid)</span>
        <span class="k">if</span> <span class="n">metaid</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">metaid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">metaid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
        <span class="n">g</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">metaid</span><span class="p">)</span>

        <span class="n">gkind</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getKind</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gkind</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">_kinds_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gkind</span> <span class="o">==</span> <span class="s1">&#39;collection&#39;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">setKind</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">GROUP_KIND_COLLECTION</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gkind</span> <span class="o">==</span> <span class="s1">&#39;partonomy&#39;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">setKind</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">GROUP_KIND_PARTONOMY</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">gkind</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">setKind</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">GROUP_KIND_CLASSIFICATION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setKind</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">GROUP_KIND_UNKNOWN</span><span class="p">)</span>

        <span class="n">sbo</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getSBOterm</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sbo</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sbo</span><span class="p">))</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>
        <span class="n">lom</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getListOfMembers</span><span class="p">()</span>
        <span class="n">metaid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_members&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">METAPREFIX</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
        <span class="n">lom</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="n">metaid</span><span class="p">)</span>
        <span class="n">sbo</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getSharedSBOterm</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sbo</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lom</span><span class="o">.</span><span class="n">setSBOTerm</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sbo</span><span class="p">))</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getSharedNotes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sbml_setNotes3</span><span class="p">(</span><span class="n">lom</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mid</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getMemberIDs</span><span class="p">():</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">createMember</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">setIdRef</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
            <span class="n">annores</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in group:&#39;</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">sharedAnno</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getSharedAnnotations</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sharedAnno</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annoSTRnew</span> <span class="o">=</span> <span class="n">sbml_writeKeyValueDataAnnotation</span><span class="p">(</span><span class="n">sharedAnno</span><span class="p">)</span>
            <span class="n">annores</span> <span class="o">=</span> <span class="n">lom</span><span class="o">.</span><span class="n">appendAnnotation</span><span class="p">(</span><span class="n">annoSTRnew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">annores</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid annotation in group:&#39;</span><span class="p">,</span> <span class="n">lom</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">sharedAnno</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sharedMiriam</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getSharedMIRIAMannotations</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sharedMiriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sharedMiriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">lom</span><span class="p">,</span> <span class="n">sharedMiriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grp</span><span class="o">.</span><span class="n">miriam</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miriam</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">miriam</span><span class="o">.</span><span class="n">getAllMIRIAMUris</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miriam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sbml_setCVterms</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">miriam</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="sbml_writeCOBRASBML"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_writeCOBRASBML">[docs]</a><span class="k">def</span> <span class="nf">sbml_writeCOBRASBML</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an FBA model object and writes it to file as a COBRA compatible :</span>

<span class="sd">     - *fba* an fba model object</span>
<span class="sd">     - *fname* the model will be written as XML to *fname*</span>
<span class="sd">     - *directory* [default=None] if defined it is prepended to fname</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: saving in COBRA format may result in a loss of model information!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">sbml_writeSBML3FBC</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">autofix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fbc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sbml_level_version</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">add_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sbml_convertSBML3FBCToCOBRA</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model exported as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span></div>


<div class="viewcode-block" id="sbml_getGeneRefs"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_getGeneRefs">[docs]</a><span class="k">def</span> <span class="nf">sbml_getGeneRefs</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk through a gene association and extract GeneRefs inspired by Frank</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">GeneProductRef</span><span class="p">):</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">association</span><span class="o">.</span><span class="n">getGeneProduct</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">association</span><span class="o">.</span><span class="n">getNumAssociations</span><span class="p">()):</span>
            <span class="n">sbml_getGeneRefs</span><span class="p">(</span><span class="n">association</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="sbml_getGPRasDictFBCv1"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_getGPRasDictFBCv1">[docs]</a><span class="k">def</span> <span class="nf">sbml_getGPRasDictFBCv1</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a GPR string &#39;((g1 and g2) or g3)&#39; to a gprDict which is returned</span>

<span class="sd">     - *node* a Python AST note (e.g. `ast.parse(gprstring).body[0]`)</span>
<span class="sd">     - *out* a new dictionary that will be be created in place</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">getGPRasDictFromString</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></div>



<div class="viewcode-block" id="sbml_getGPRasDictFBCv2"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_getGPRasDictFBCv2">[docs]</a><span class="k">def</span> <span class="nf">sbml_getGPRasDictFBCv2</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">cntr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk through an SBML L3FBCV2 gene protein association and return a dictionary/tree representation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">cntr</span>
    <span class="c1">#print(association)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">GeneProductRef</span><span class="p">):</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">association</span><span class="o">.</span><span class="n">getGeneProduct</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ref</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">FbcAnd</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_AND_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">association</span><span class="o">.</span><span class="n">getNumAssociations</span><span class="p">()):</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_AND_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sbml_getGPRasDictFBCv2</span><span class="p">(</span><span class="n">association</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_AND_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span> <span class="n">cntr</span><span class="p">))</span>
            <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">FbcOr</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_OR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">association</span><span class="o">.</span><span class="n">getNumAssociations</span><span class="p">()):</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_OR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sbml_getGPRasDictFBCv2</span><span class="p">(</span><span class="n">association</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_OR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span> <span class="n">cntr</span><span class="p">))</span>
            <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="sbml_createAssociationFromAST"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_createAssociationFromAST">[docs]</a><span class="k">def</span> <span class="nf">sbml_createAssociationFromAST</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a GPR string &#39;((g1 and g2) or g3)&#39; to an association via a Python AST.</span>
<span class="sd">    In future I will get rid of all the string elements and work only with associations</span>
<span class="sd">    and AST&#39;s.</span>

<span class="sd">     - *node* a Python AST note (e.g. body)</span>
<span class="sd">     - *out* a new shiny FBC V2 GeneProductAssociation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createGeneProductRef</span><span class="p">()</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">setGeneProduct</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">id</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">id</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createGeneProductRef</span><span class="p">()</span>
        <span class="n">gref</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">setGeneProduct</span><span class="p">(</span><span class="n">formatSbmlId</span><span class="p">(</span><span class="n">gref</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">):</span>
                <span class="n">newex</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createAnd</span><span class="p">()</span>
                <span class="c1">#print(&#39;And&#39;, v)</span>
                <span class="c1">#walk(v, newand)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Or</span><span class="p">):</span>
                <span class="n">newex</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createOr</span><span class="p">()</span>
                <span class="c1">#print(&#39;Or&#39;, v)</span>
                <span class="c1">#walk(v, newor)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#print(&#39;--&gt;&#39;, v)</span>
                <span class="n">newex</span> <span class="o">=</span> <span class="n">out</span>
            <span class="n">sbml_createAssociationFromAST</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">newex</span><span class="p">)</span></div>

<div class="viewcode-block" id="sbml_createAssociationFromTreeV2"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_createAssociationFromTreeV2">[docs]</a><span class="k">def</span> <span class="nf">sbml_createAssociationFromTreeV2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a GPR tree to an association</span>

<span class="sd">     - *tree* a GPR dict tree</span>
<span class="sd">     - *out* a new shiny FBC V2 GeneProductAssociation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_AND_&#39;</span><span class="p">):</span>
            <span class="n">newex</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createAnd</span><span class="p">()</span>
            <span class="n">sbml_createAssociationFromTreeV2</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">newex</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_OR_&#39;</span><span class="p">):</span>
            <span class="n">newex</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createOr</span><span class="p">()</span>
            <span class="n">sbml_createAssociationFromTreeV2</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">newex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">createGeneProductRef</span><span class="p">()</span>
            <span class="n">ref</span><span class="o">.</span><span class="n">setGeneProduct</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="sbml_writeSBML3FBC"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_writeSBML3FBC">[docs]</a><span class="k">def</span> <span class="nf">sbml_writeSBML3FBC</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sbml_level_version</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">autofix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fbc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gpr_from_annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                       <span class="n">add_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_cbmpy_annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_cobra_annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xoptions</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an FBA model object and writes it to file as SBML L3 FBC:</span>

<span class="sd">     - *fba* an fba model object</span>
<span class="sd">     - *fname* the model will be written as XML to *fname*</span>
<span class="sd">     - *directory* [default=None] if defined it is prepended to fname</span>
<span class="sd">     - *sbml_level_version* [default=(3,1)] a tuple containing the SBML level and version e.g. (3,1)</span>
<span class="sd">     - *autofix* convert &lt;&gt; to &lt;=&gt;=</span>
<span class="sd">     - *return_fbc* return the FBC converter instance</span>
<span class="sd">     - *gpr_from_annot* [default=False] if enabled will attempt to add the gene protein associations from the annotations</span>
<span class="sd">       if no gene protein association objects exist</span>
<span class="sd">     - *add_cbmpy_annot* [default=True] add CBMPy KeyValueData annotation. Replaces &lt;notes&gt;</span>
<span class="sd">     - *add_cobra_annot* [default=True] add COBRA &lt;notes&gt; annotation</span>
<span class="sd">     - *xoptions* extended options</span>

<span class="sd">       - *fbc_version* [default=1] write SBML3FBC using version 1 (2013) or version 2 (2015)</span>
<span class="sd">       - *validate* [default=False] validate the output SBML file</span>
<span class="sd">       - *compress_bounds* [default=False] try compress output flux bound parameters</span>
<span class="sd">       - *zip_model* [default=False] compress the model using ZIP encoding</span>
<span class="sd">       - *return_model_string* [default=False] return the SBML XML file as a string</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SBML not available ... install libSBML with Python bindings for SBML support&quot;</span>


    <span class="c1"># load options</span>
    <span class="n">fbc_version</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">VALIDATE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">compress_bounds</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">zip_model</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">return_model_string</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;fbc_version&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span><span class="p">:</span>
        <span class="n">fbc_version</span> <span class="o">=</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;fbc_version&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;validate&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span><span class="p">:</span>
        <span class="n">VALIDATE</span> <span class="o">=</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;return_model_string&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span><span class="p">:</span>
        <span class="n">return_model_string</span> <span class="o">=</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;return_model_string&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;compress_bounds&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">compress_bounds</span> <span class="o">=</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;compress_bounds&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;zip_model&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span><span class="p">:</span>
        <span class="n">zip_model</span> <span class="o">=</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;zip_model&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">autofix</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: using FBC version: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fbc_version</span><span class="p">))</span>

    <span class="k">if</span>  <span class="n">fba</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">]:</span>
        <span class="c1">##fba.setName(&#39;cbmpy_fbc_v{}_model&#39;.format(fbc_version))</span>
        <span class="n">fba</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s1">&#39;cbmpy_fbc_model&#39;</span><span class="p">)</span>
    <span class="n">fba</span><span class="o">.</span><span class="n">setModifiedDate</span><span class="p">()</span>

    <span class="n">USE_GROUPS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">add_groups</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fba</span><span class="o">.</span><span class="n">groups</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">USE_GROUPS</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">cs3</span> <span class="o">=</span> <span class="n">CBMtoSBML3</span><span class="p">(</span><span class="n">fba</span><span class="p">,</span> <span class="n">fbc_version</span><span class="p">,</span> <span class="n">fbc_strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_groups</span><span class="o">=</span><span class="n">USE_GROUPS</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cs3</span><span class="o">.</span><span class="n">addBoundsV1</span><span class="p">(</span><span class="n">autofix</span><span class="o">=</span><span class="n">autofix</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">cs3</span><span class="o">.</span><span class="n">addBoundsV2</span><span class="p">(</span><span class="n">compress_bounds</span><span class="o">=</span><span class="n">compress_bounds</span><span class="p">)</span>

    <span class="n">cs3</span><span class="o">.</span><span class="n">addObjectives</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cs3</span><span class="o">.</span><span class="n">addGeneProteinAssociationsV1</span><span class="p">(</span><span class="n">parse_from_annotation</span><span class="o">=</span><span class="n">gpr_from_annot</span><span class="p">,</span> <span class="n">annotation_key</span><span class="o">=</span><span class="s1">&#39;GENE_ASSOCIATION&#39;</span><span class="p">,</span>\
                                         <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="n">add_cbmpy_annot</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fbc_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">cs3</span><span class="o">.</span><span class="n">addGenesV2</span><span class="p">(</span><span class="n">parse_from_annotation</span><span class="o">=</span><span class="n">gpr_from_annot</span><span class="p">,</span> <span class="n">annotation_key</span><span class="o">=</span><span class="s1">&#39;GENE_ASSOCIATION&#39;</span><span class="p">,</span>\
                       <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="n">add_cbmpy_annot</span><span class="p">)</span>

    <span class="c1"># create a model</span>
    <span class="n">sbml_setDescription</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">)</span>
    <span class="n">sbml_setUnits</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L3</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sbml_setSpeciesL3</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">,</span> <span class="n">add_cobra_anno</span><span class="o">=</span><span class="n">add_cobra_annot</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="n">add_cbmpy_annot</span><span class="p">,</span> <span class="n">substance_units</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sbml_setCompartmentsL3</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fba</span><span class="p">)</span>
    <span class="n">sbml_setReactionsL3Fbc</span><span class="p">(</span><span class="n">cs3</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_cobra_anno</span><span class="o">=</span><span class="n">add_cobra_annot</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="n">add_cbmpy_annot</span><span class="p">,</span> <span class="n">fbc_version</span><span class="o">=</span><span class="n">fbc_version</span><span class="p">)</span>
    <span class="n">sbml_setParametersL3Fbc</span><span class="p">(</span><span class="n">cs3</span><span class="p">,</span> <span class="n">add_cbmpy_anno</span><span class="o">=</span><span class="n">add_cbmpy_annot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">USE_GROUPS</span><span class="p">:</span>
        <span class="n">sbml_setGroupsL3</span><span class="p">(</span><span class="n">cs3</span><span class="p">,</span> <span class="n">fba</span><span class="p">)</span>

    <span class="c1"># stop libSBML deleting all my annotations</span>
    <span class="n">cs3</span><span class="o">.</span><span class="n">addModelHistory</span><span class="p">()</span>
    <span class="n">cs3</span><span class="o">.</span><span class="n">addModelAnnotation</span><span class="p">(</span><span class="n">fba</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">directory</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">directory</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span> <span class="n">UseR</span> <span class="o">=</span> <span class="n">getuser</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span> <span class="n">UseR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">h1</span> <span class="o">=</span> <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">h1</span> <span class="o">+=</span> <span class="s1">&#39;&lt;!-- SBML created with CBMPy (&#39;</span><span class="o">+</span> <span class="n">__version__</span> <span class="o">+</span> <span class="s1">&#39;) on &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; --&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">return_model_string</span><span class="p">:</span>
        <span class="n">modstr</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">+</span> <span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">toSBML</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model returned as string&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">zip_model</span><span class="p">:</span>
        <span class="n">cs3</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">writeSBMLToFile</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.zip&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model exported as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.zip&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#raw_input(&#39;L%sV%s&#39; % (document.getLevel(),document.getVersion()))</span>
        <span class="n">F</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">F</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">h1</span> <span class="o">+</span> <span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">toSBML</span><span class="p">())</span>
        <span class="n">F</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">F</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model exported as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>


    <span class="c1"># bgoli: temporary (until incorporated into FBC stadard) solution to store the constraints in a separate json file</span>
    <span class="k">if</span> <span class="n">fba</span><span class="o">.</span><span class="n">user_constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fba</span><span class="o">.</span><span class="n">user_constraints</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fba</span><span class="o">.</span><span class="n">exportUserConstraints</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.user_constraints.json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VALIDATE</span><span class="p">:</span>
        <span class="n">sbml_setValidationOptions</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performing validation on output SBML ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">DOCUMENT_VALID</span><span class="p">,</span> <span class="n">MODEL_VALID</span> <span class="o">=</span> <span class="n">sbml_validateDocument</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">fullmsg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DOCUMENT_VALID</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_model_string</span><span class="p">:</span>
                <span class="n">fname2</span> <span class="o">=</span> <span class="s1">&#39;model.invalid.xml&#39;</span>
                <span class="n">cs3</span><span class="o">.</span><span class="n">sbml</span><span class="o">.</span><span class="n">writeSBMLToFile</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">fname2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname2</span> <span class="o">=</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.invalid&#39;</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fname2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SBML document is invalid and written as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname2</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MODEL_VALID</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SBML document is valid but the model is not (or is incomplete):&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">sbml_setValidationOptions</span><span class="p">(</span><span class="n">cs3</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

    <span class="n">cs3</span><span class="o">.</span><span class="n">_cleanUP_</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">cs3</span>
    <span class="k">if</span> <span class="n">return_model_string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">modstr</span></div>

<div class="viewcode-block" id="sbml_setValidationOptions"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setValidationOptions">[docs]</a><span class="k">def</span> <span class="nf">sbml_setValidationOptions</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set the validation level of an SBML document</span>

<span class="sd">     - *D* an SBML document</span>
<span class="sd">     - *level* the level of consistency check can be either one of:</span>

<span class="sd">      - &#39;normal&#39; basic id checking only</span>
<span class="sd">      - &#39;full&#39; all checks enabled</span>
<span class="sd">      - None disable all validation</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_IDENTIFIER_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_INTERNAL_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_GENERAL_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_UNITS_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_MATHML_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_SBO_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_OVERDETERMINED_MODEL</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_MODELING_PRACTICE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_IDENTIFIER_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_INTERNAL_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_GENERAL_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_UNITS_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_MATHML_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_SBO_CONSISTENCY</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_OVERDETERMINED_MODEL</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_MODELING_PRACTICE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_IDENTIFIER_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_INTERNAL_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_GENERAL_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_UNITS_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_MATHML_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_SBO_CONSISTENCY</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_OVERDETERMINED_MODEL</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">setConsistencyChecks</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_CAT_MODELING_PRACTICE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>




<div class="viewcode-block" id="sbml_readCOBRASBML"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_readCOBRASBML">[docs]</a><span class="k">def</span> <span class="nf">sbml_readCOBRASBML</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_sbml_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delete_intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fake_boundary_species_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">speciesAnnotationFix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_genes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in a COBRA format SBML Level 2 file with FBA annotation where and return either a CBM model object</span>
<span class="sd">    or a (cbm_mod, sbml_mod) pair if return_sbml_model=True</span>

<span class="sd">     - *fname* is the filename</span>
<span class="sd">     - *work_dir* is the working directory</span>
<span class="sd">     - *return_sbml_model* [default=False] return a a (cbm_mod, sbml_mod) pair</span>
<span class="sd">     - *delete_intermediate* [default=False] delete the intermediate SBML Level 3 FBC file</span>
<span class="sd">     - *fake_boundary_species_search* [default=False] after looking for the boundary_condition of a species search for overloaded id&#39;s &lt;id&gt;_b</span>
<span class="sd">     - *output_dir* [default=None] the directory to output the intermediate SBML L3 files (if generated) default to input directory</span>
<span class="sd">     - *speciesAnnotationFix* [default=True]</span>
<span class="sd">     - *skip_genes* [default=False] convert GPR associations</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_file</span> <span class="o">=</span> <span class="n">sbml_convertCOBRASBMLtoFBC</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">COBRA file conversion failed:</span><span class="se">\n\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">why</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">sbml_readSBML3FBC</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">return_sbml_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xoptions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nogenes&#39;</span> <span class="p">:</span> <span class="n">skip_genes</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">fake_boundary_species_search</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_sbml_model</span><span class="p">:</span>
            <span class="n">cmod</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmod</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">cmod</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">s_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sid</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_b&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Fake boundary (_b) metabolite fixed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
                <span class="n">s_</span><span class="o">.</span><span class="n">setBoundary</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">speciesAnnotationFix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_sbml_model</span><span class="p">:</span>
            <span class="n">cmod</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmod</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">cmod</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">processSpeciesChargeChemFormulaAnnot</span><span class="p">(</span><span class="n">s_</span><span class="p">,</span> <span class="n">getFromName</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwriteCharge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwriteChemFormula</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processSpeciesChargeChemFormulaAnnot failed for species with id: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
        <span class="n">sbml_writeSBML3FBC</span><span class="p">(</span><span class="n">cmod</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">new_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delete_intermediate</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: SBML Level 3 + FBC file generated as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_file</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="sbml_convertCOBRASBMLtoFBC"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_convertCOBRASBMLtoFBC">[docs]</a><span class="k">def</span> <span class="nf">sbml_convertCOBRASBMLtoFBC</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in a COBRA SBML Level 2 file and return the name of the created SBML Level 3 with FBC</span>
<span class="sd">    file that is created in the output directory</span>

<span class="sd">     - *fname* is the filename</span>
<span class="sd">     - *outname* the name of the output file. If not specified then &lt;filename&gt;.l3fbc.xml is used as default</span>
<span class="sd">     - *work_dir* [default=None] is the working directory</span>
<span class="sd">     - *output_dir* [default=None] is the output directory (default is work_dir)</span>

<span class="sd">    This method is based on code from libSBML (http://sbml.org) in the file &quot;convertCobra.py&quot;</span>
<span class="sd">    written by Frank T. Bergmann.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: SBML not available ... install libSBML 5.8.0 r newer with Python bindings for SBML (http://sbml.org/Downloads)&quot;</span>
    <span class="k">assert</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_VERSION</span> <span class="o">&gt;=</span> <span class="mi">50800</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING: COBRA SBML import requires libSBML 5.8.0 or newer (your version: </span><span class="si">{}</span><span class="s2">) (http://sbml.org/Downloads)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_VERSION</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">work_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fname_only</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">fname_only</span> <span class="o">=</span> <span class="n">work_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">work_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">work_dir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ERROR: file </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> does not exist&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newfname</span> <span class="o">=</span> <span class="n">outname</span>
    <span class="c1">#elif fname[-4:] == &#39;.xml&#39;:</span>
        <span class="c1">#newfname = fname_only.replace(&#39;.xml&#39;, &#39;.l3fbc.xml&#39;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newfname</span> <span class="o">=</span> <span class="n">fname_only</span><span class="o">+</span><span class="s1">&#39;.l3fbc.xml&#39;</span>

    <span class="n">newfname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">newfname</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">work_dir: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">work_dir</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output_dir: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fname: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;newfname: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newfname</span><span class="p">))</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Read ...&#39;</span><span class="p">)</span>
    <span class="n">sbmldoc</span> <span class="o">=</span> <span class="n">SBMLreader</span><span class="o">.</span><span class="n">readSBML</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Read reports </span><span class="si">{}</span><span class="s1"> errors&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sbmldoc</span><span class="o">.</span><span class="n">getNumErrors</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">sbmldoc</span><span class="o">.</span><span class="n">getNumErrors</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sbmldoc</span><span class="o">.</span><span class="n">getError</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">getErrorId</span><span class="p">()</span> <span class="o">==</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">XMLFileUnreadable</span><span class="p">:</span>
            <span class="c1"># Handle case of unreadable file here.</span>
            <span class="n">sbmldoc</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sbmldoc</span><span class="o">.</span><span class="n">getError</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">getErrorId</span><span class="p">()</span> <span class="o">==</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">XMLFileOperationError</span><span class="p">:</span>
            <span class="c1"># Handle case of other file error here.</span>
            <span class="n">sbmldoc</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle other error cases here.</span>
            <span class="n">sbmldoc</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">props</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">ConversionProperties</span><span class="p">()</span>
    <span class="n">props</span><span class="o">.</span><span class="n">addOption</span><span class="p">(</span><span class="s2">&quot;convert cobra&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;convert cobra sbml to fbc&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Convert ...&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sbmldoc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Convert returns result </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Error] Conversion failed... (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">SBMLwriter</span><span class="o">.</span><span class="n">writeSBML</span><span class="p">(</span><span class="n">sbmldoc</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">newfname</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INFO: successfully converted file </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">newfname</span><span class="p">))</span>
    <span class="n">props</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">del</span> <span class="n">sbmldoc</span>
    <span class="n">sbmldoc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">newfname</span></div>

<div class="viewcode-block" id="sbml_convertSBML3FBCToCOBRA"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_convertSBML3FBCToCOBRA">[docs]</a><span class="k">def</span> <span class="nf">sbml_convertSBML3FBCToCOBRA</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in a SBML Level 3 file and return the name of the created COBRA</span>
<span class="sd">    file that is created in the output directory</span>

<span class="sd">     - *fname* is the filename</span>
<span class="sd">     - *outname* the name of the output file. If not specified then &lt;filename&gt;.cobra.xml is used as default</span>
<span class="sd">     - *work_dir* [default=None] is the working directory</span>
<span class="sd">     - *output_dir* [default=None] is the output directory (default is work_dir)</span>

<span class="sd">    This method is based on code from libSBML (http://sbml.org) in the file &quot;convertFbcToCobra.py&quot;</span>
<span class="sd">    written by Frank T. Bergmann.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR: SBML not available ... install libSBML 5.8.0 r newer with Python bindings for SBML (http://sbml.org/Downloads)&quot;</span>
    <span class="k">assert</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_VERSION</span> <span class="o">&gt;=</span> <span class="mi">50800</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING: COBRA SBML import requires libSBML 5.8.0 or newer (your version: </span><span class="si">{}</span><span class="s2">) (http://sbml.org/Downloads)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_VERSION</span><span class="p">)</span>

    <span class="c1">#global SBMLreader, SBMLwriter</span>


    <span class="k">if</span> <span class="n">work_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fname_only</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">fname_only</span> <span class="o">=</span> <span class="n">work_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">work_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">work_dir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ERROR: file </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> does not exist&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">newfname</span> <span class="o">=</span> <span class="n">outname</span>
    <span class="c1">#elif fname[-4:] == &#39;.xml&#39;:</span>
        <span class="c1">#newfname = fname_only.replace(&#39;.xml&#39;, &#39;.l3fbc.xml&#39;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newfname</span> <span class="o">=</span> <span class="n">fname_only</span><span class="o">+</span><span class="s1">&#39;.cobra.xml&#39;</span>

    <span class="n">newfname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">newfname</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">work_dir: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">work_dir</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;output_dir: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fname: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;newfname: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newfname</span><span class="p">))</span>

    <span class="c1">#SBMLreader  = libsbml.SBMLReader()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Read ...&#39;</span><span class="p">)</span>
    <span class="n">sbmldoc</span> <span class="o">=</span> <span class="n">SBMLreader</span><span class="o">.</span><span class="n">readSBML</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converter reports </span><span class="si">{}</span><span class="s1"> errors, this is probably normal.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sbmldoc</span><span class="o">.</span><span class="n">getNumErrors</span><span class="p">()))</span>
    <span class="c1"># debug stuff</span>
    <span class="c1">#M = sbmldoc.getModel()</span>
    <span class="c1">#for s_ in range(M.getNumSpecies()):</span>
        <span class="c1">#s = M.getSpecies(s_)</span>
        <span class="c1">#s.unsetAnnotation()</span>
        <span class="c1">#s.unsetNotes()</span>
    <span class="c1">#for r_ in range(M.getNumReactions()):</span>
        <span class="c1">#r = M.getReaction(r_)</span>
        <span class="c1">#r.unsetAnnotation()</span>
        <span class="c1">#r.unsetNotes()</span>

    <span class="c1">#if sbmldoc.getNumErrors() &gt; 0:</span>
        <span class="c1">#if sbmldoc.getError(0).getErrorId() == libsbml.XMLFileUnreadable:</span>
            <span class="c1">## Handle case of unreadable file here.</span>
            <span class="c1">#sbmldoc.printErrors()</span>
        <span class="c1">#elif sbmldoc.getError(0).getErrorId() == libsbml.XMLFileOperationError:</span>
            <span class="c1">## Handle case of other file error here.</span>
            <span class="c1">#sbmldoc.printErrors()</span>
        <span class="c1">#else:</span>
            <span class="c1">## Handle other error cases here.</span>
            <span class="c1">#sbmldoc.printErrors()</span>
        <span class="c1">#return None</span>

    <span class="n">props</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">ConversionProperties</span><span class="p">()</span>
    <span class="n">props</span><span class="o">.</span><span class="n">addOption</span><span class="p">(</span><span class="s2">&quot;convert fbc to cobra&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Convert FBC model to Cobra model&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Convert ...&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sbmldoc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Convert returns result </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Error] Conversion failed... (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">SBMLwriter</span><span class="o">.</span><span class="n">writeSBML</span><span class="p">(</span><span class="n">sbmldoc</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">newfname</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INFO: successfully converted file </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">newfname</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">sbmldoc</span>
    <span class="k">return</span> <span class="n">newfname</span></div>

<div class="viewcode-block" id="sbml_validateDocument"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_validateDocument">[docs]</a><span class="k">def</span> <span class="nf">sbml_validateDocument</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">fullmsg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates and SBML document returns three dictionaries, errors, warnings, other and a boolean indicating an invalid document:</span>

<span class="sd">     - *D* and SBML document</span>
<span class="sd">     - *fullmsg* [default=False] optionally display the full error message</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">warnings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">others</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">DOCUMENT_VALID</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">MODEL_VALID</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">e_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">validateSBML</span><span class="p">()):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">getError</span><span class="p">(</span><span class="n">e_</span><span class="p">)</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">getErrorId</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">getLine</span><span class="p">()],</span>
               <span class="s1">&#39;msg&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getShortMessage</span><span class="p">(),</span>
               <span class="s1">&#39;fullmsg&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="p">(),</span>
               <span class="s1">&#39;severity_int&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getSeverity</span><span class="p">(),</span>
               <span class="s1">&#39;package&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getPackage</span><span class="p">(),</span>
               <span class="s1">&#39;severity&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">getSeverityAsString</span><span class="p">(),</span>
               <span class="s1">&#39;isfatal&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">isFatal</span><span class="p">(),</span>
               <span class="s1">&#39;isxml&#39;</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">isXML</span><span class="p">()</span>
               <span class="p">}</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;isfatal&#39;</span><span class="p">]:</span>
            <span class="n">DOCUMENT_VALID</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">MODEL_VALID</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># fail model validaty on model error</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;severity_int&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">MODEL_VALID</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">isError</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]:</span>
                    <span class="n">errors</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">isWarning</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
                <span class="n">warnings</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]:</span>
                    <span class="n">warnings</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
                <span class="n">others</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">others</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]:</span>
                    <span class="n">others</span><span class="p">[</span><span class="n">eid</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">del</span> <span class="n">e</span>

    <span class="n">not_relevant</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20221</span><span class="p">,</span> <span class="mi">20616</span><span class="p">,</span> <span class="mi">80601</span><span class="p">,</span> <span class="mi">99130</span><span class="p">,</span> <span class="mi">99508</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">er</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">er</span> <span class="ow">in</span> <span class="n">not_relevant</span><span class="p">:</span>
            <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NAtoFBC&#39;</span>
        <span class="k">elif</span> <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fullmsg</span><span class="p">:</span>
            <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;fullmsg&#39;</span><span class="p">]</span>
            <span class="n">warnings</span><span class="p">[</span><span class="n">er</span><span class="p">][</span><span class="s1">&#39;fullmsg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validation report:</span><span class="se">\n</span><span class="s1">==================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Errors</span><span class="se">\n</span><span class="s1">------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">eidx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">eidx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e_</span> <span class="ow">in</span> <span class="n">eidx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error </span><span class="si">{}</span><span class="s1"> (severity=</span><span class="si">{}</span><span class="s1">):</span><span class="se">\n\n</span><span class="s1"> - </span><span class="si">{}</span><span class="se">\n</span><span class="s1"> - lines: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e_</span><span class="p">,</span> <span class="n">errors</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;severity&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;msg&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warnings</span><span class="se">\n</span><span class="s1">--------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">eidx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">warnings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">eidx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e_</span> <span class="ow">in</span> <span class="n">eidx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning </span><span class="si">{}</span><span class="s1"> (severity=</span><span class="si">{}</span><span class="s1">):</span><span class="se">\n\n</span><span class="s1"> - </span><span class="si">{}</span><span class="se">\n</span><span class="s1"> - lines: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e_</span><span class="p">,</span> <span class="n">warnings</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;severity&#39;</span><span class="p">],</span> <span class="n">warnings</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;msg&#39;</span><span class="p">],</span> <span class="n">warnings</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">others</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Other</span><span class="se">\n</span><span class="s1">-----</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">eidx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">others</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">eidx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e_</span> <span class="ow">in</span> <span class="n">eidx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Info </span><span class="si">{}</span><span class="s1"> (severity=</span><span class="si">{}</span><span class="s1">):</span><span class="se">\n\n</span><span class="s1"> - </span><span class="si">{}</span><span class="se">\n</span><span class="s1"> - lines: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e_</span><span class="p">,</span> <span class="n">others</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;severity&#39;</span><span class="p">],</span> <span class="n">others</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;msg&#39;</span><span class="p">],</span> <span class="n">others</span><span class="p">[</span><span class="n">e_</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;End.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">DOCUMENT_VALID</span><span class="p">,</span> <span class="n">MODEL_VALID</span></div>

<div class="viewcode-block" id="sbml_fileValidate"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_fileValidate">[docs]</a><span class="k">def</span> <span class="nf">sbml_fileValidate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate an SBML file and model</span>

<span class="sd">     - *f* the SBML file</span>
<span class="sd">     - *level* [default=&#39;normal&#39;] the level of validation &quot;normal&quot; or &quot;full&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: invalid file&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">readSBMLFromFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">sbml_setValidationOptions</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performing validation on input SBML ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">DOCUMENT_VALID</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">warnings</span> <span class="o">=</span> <span class="n">others</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">DOCUMENT_VALID</span><span class="p">,</span> <span class="n">MODEL_VALID</span> <span class="o">=</span> <span class="n">sbml_validateDocument</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">D</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DOCUMENT_VALID</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Validation </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> has detected an invalid SBML document&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">MODEL_VALID</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Validation </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> has detected an invalid SBML model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Validation </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> successful&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">DOCUMENT_VALID</span><span class="p">,</span> <span class="n">MODEL_VALID</span><span class="p">,</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="sbml_fileFindVersion"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_fileFindVersion">[docs]</a><span class="k">def</span> <span class="nf">sbml_fileFindVersion</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try and find the SBML version and FBC support</span>

<span class="sd">     - *f* the SBML file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: invalid file&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">readSBMLFromFile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">getNamespaces</span><span class="p">()</span>
    <span class="n">uris</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">getNumNamespaces</span><span class="p">()):</span>
        <span class="n">uris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">getURI</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ns</span><span class="p">,</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">SBML_NS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">uris</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span>
        <span class="n">F</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">l2type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">F</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;&lt;fba:fluxBalance xmlns:fba=&quot;http://www.sbml.org/sbml/level3/version1/fba/version1&quot;&gt;&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">l2type</span> <span class="o">=</span> <span class="s1">&#39;L2FBA&#39;</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="s1">&#39;&lt;parameter id=&quot;OBJECTIVE_COEFFICIENT&quot; value=&quot;0&quot;&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">l2type</span> <span class="o">=</span> <span class="s1">&#39;COBRA&#39;</span>
                <span class="k">break</span>
        <span class="n">F</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">l2type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">l2type</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;L3V1FBC1&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;SBML Level 3 FBC version 1 model detected, loading with cbmpy.readSBML3FBC()&#39;</span>
    <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;L3V1FBC2&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;SBML Level 3 FBC version 2 model detected, loading with cbmpy.readSBML3FBC()&#39;</span>
    <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;L2FBA&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;SBML Level 2 FAME model detected, loading with cbmpy.readSBML2FBA()&#39;</span>
    <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;COBRA&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;COBRA SBML L2 model detected, loading with cbmpy.readCOBRASBML()&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Unknown model type, contact the SBML community or developer for more details.&#39;</span>
    <span class="k">del</span> <span class="n">D</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="setCBSBOterm"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.setCBSBOterm">[docs]</a><span class="k">def</span> <span class="nf">setCBSBOterm</span><span class="p">(</span><span class="n">sbo</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an SBOterm from libSBML, add it to a CBMPy object</span>

<span class="sd">     - *sbo* the sbo term string</span>
<span class="sd">     - *obj* the CBMPy Fbase derived object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sbo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sbo</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setSBOterm</span><span class="p">(</span><span class="n">sbo</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: </span><span class="si">{}</span><span class="s1"> is not a valid SBO term and is being ignored.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sbo</span><span class="p">))</span></div>

<div class="viewcode-block" id="sbml_readSBML3FBC"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_readSBML3FBC">[docs]</a><span class="k">def</span> <span class="nf">sbml_readSBML3FBC</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_sbml_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xoptions</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in an SBML Level 3 file with FBC annotation where and return either a CBM model object</span>
<span class="sd">    or a (cbm_mod, sbml_mod) pair if return_sbml_model=True</span>

<span class="sd">     - *fname* is the filename</span>
<span class="sd">     - *work_dir* is the working directory</span>
<span class="sd">     - *return_sbml_model* [default=False] return a a (cbm_mod, sbml_mod) pair</span>
<span class="sd">     - *xoptions* special load options enable with option = True</span>

<span class="sd">       - *nogenes* do not load/process genes</span>
<span class="sd">       - *noannot* do not load/process any annotations</span>
<span class="sd">       - *validate* validate model and display errors and warnings before loading</span>
<span class="sd">       - *readcobra* read the cobra annotation</span>
<span class="sd">       - *read_model_string* [default=False] read the model from a string (instead of a filename) containing an SBML document</span>
<span class="sd">       - *nmatrix_type* [default=&#39;normal&#39;] define the type of stoichiometrich matrix to be built</span>

<span class="sd">         - &#39;numpy&#39; dense numpy array (best performance)</span>
<span class="sd">         - &#39;scipy_csr&#39; scipy sparse matrix (lower performance, low memory)</span>
<span class="sd">         - &#39;sympy&#39; a sympy rational matrix (low performance, high memory, cast to dense to analyse)</span>
<span class="sd">         - None do not build matrix</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">time00</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">_HAVE_SBML_</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SBML not available ... install libSBML with Python bindings for SBML support&quot;</span>

    <span class="c1"># load options</span>
    <span class="n">LOADGENES</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">LOADANNOT</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">VALIDATE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">READCOBRA</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">READ_MODEL_STRING</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">NMATRIX_TYPE</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;nogenes&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;nogenes&#39;</span><span class="p">]:</span>
        <span class="n">LOADGENES</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">GPR loading disabled!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;noannot&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;noannot&#39;</span><span class="p">]:</span>
        <span class="n">LOADANNOT</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Annotation loading disabled!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;debug&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
        <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Debug enabled!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;validate&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
        <span class="n">VALIDATE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;readcobra&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;readcobra&#39;</span><span class="p">]:</span>
        <span class="n">READCOBRA</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;read_model_string&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span> <span class="ow">and</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;read_model_string&#39;</span><span class="p">]:</span>
        <span class="n">READ_MODEL_STRING</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;nmatrix_type&#39;</span> <span class="ow">in</span> <span class="n">xoptions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;nmatrix_type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;nmatrix_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">NMATRIX_TYPE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;nmatrix_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">NMATRIX_TYPE</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
        <span class="k">elif</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;nmatrix_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;scipy_csr&#39;</span><span class="p">:</span>
            <span class="n">NMATRIX_TYPE</span> <span class="o">=</span> <span class="s1">&#39;scipy_csr&#39;</span>
        <span class="k">elif</span> <span class="n">xoptions</span><span class="p">[</span><span class="s1">&#39;nmatrix_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sympy&#39;</span><span class="p">:</span>
            <span class="n">NMATRIX_TYPE</span> <span class="o">=</span> <span class="s1">&#39;sympy&#39;</span>

    <span class="n">D</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">READ_MODEL_STRING</span><span class="p">:</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">readSBMLFromString</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;string_source&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">work_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">readSBMLFromFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">readSBMLFromFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

    <span class="c1"># set consistency checking level for document</span>

    <span class="k">if</span> <span class="n">VALIDATE</span><span class="p">:</span>
        <span class="n">sbml_setValidationOptions</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performing validation on input SBML ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">DOCUMENT_VALID</span><span class="p">,</span> <span class="n">MODEL_VALID</span> <span class="o">=</span> <span class="n">sbml_validateDocument</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DOCUMENT_VALID</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validation has detected an invalid SBML document&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">MODEL_VALID</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ERROR: SBML document is valid but the model contains errors, I will try to load it anyway</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sbml_setValidationOptions</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">getModel</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">M</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Invalid SBML file&quot;</span>
    <span class="k">assert</span> <span class="n">M</span><span class="o">.</span><span class="n">getLevel</span><span class="p">()</span> <span class="o">&gt;=</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">M</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An SBML L3V1 or greater model is required&quot;</span>

    <span class="c1">## we are now going to allow loading non-FBC models (just to be friendly)</span>
    <span class="n">HAVE_FBC</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">libsbml</span><span class="p">,</span> <span class="s1">&#39;Objective&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">SBML FBC package required, see http://sbml.org/Documents/Specifications/SBML_Level_3/Packages/Flux_Balance_Constraints_</span><span class="si">%28f</span><span class="s2">lux%29 for more details.&quot;</span><span class="p">)</span>
        <span class="n">HAVE_FBC</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
        <span class="n">FBCplg</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;fbc&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">FBCplg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">HAVE_FBC</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Model is not an SBML3 FBC model.</span><span class="se">\n</span><span class="s1">Please try cbmpy.readCOBRASBML(</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">) for models encoded in the COBRA dialect</span><span class="se">\n</span><span class="s1">or cbmpy.readSBML2FBA(</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">) for models in FAME format.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="c1">#return None</span>

    <span class="n">FBCver</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">FBCstrict</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
        <span class="n">FBCver</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getPackageVersion</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">FBCstrict</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getStrict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">FBCstrict</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING!!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This model has fbc:strict=</span><span class="se">\&quot;</span><span class="s2">false</span><span class="se">\&quot;</span><span class="s2"> this means that is not necessarily a linear program and may contain a number of unsupported features containing aribtrary mathematical expressions such as, InitialAssignments, Rules, Events etc.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CBMPy can continue to load this model but will treat it as a convex linear problem and only load what it can interpret.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING!!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you wish to continue (Y/N): &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># print some model information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FBC version: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FBCver</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M.getNumReactions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumReactions</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M.getNumSpecies: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumSpecies</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FBC.getNumObjectives: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumObjectives</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FBC.getNumGeneAssociations: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumGeneAssociations</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FBC.getNumFluxBounds: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumFluxBounds</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FBC.getNumParameters: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumParameters</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FBC.getNumGeneProducts: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumGeneProducts</span><span class="p">()))</span>

    <span class="n">model_id</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
    <span class="n">model_description</span> <span class="o">=</span> <span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">model_description</span> <span class="o">=</span> <span class="n">xml_stripTags</span><span class="p">(</span><span class="n">model_description</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">__HAVE_FBA_ANOT_OBJ__</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">__HAVE_FBA_ANOT_GENEASS__</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumFluxBounds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumObjectives</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">__HAVE_FBA_ANOT_OBJ__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumGeneAssociations</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">__HAVE_FBA_ANOT_GENEASS__</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">__HAVE_FBA_ANOT_OBJ__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">__HAVE_FBA_ANOT_BNDS__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">__HAVE_FBA_ANOT_GENEASS__</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">SPEC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumSpecies</span><span class="p">()):</span>
        <span class="c1"># add support for initialAmount and hasOnlySubstanceUnits</span>
        <span class="n">SBSp</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">boundCon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getBoundaryCondition</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Real boundary metabolite: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>
            <span class="n">boundCon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">CF</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># chemical formula</span>
        <span class="n">CH</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
            <span class="n">SBSpF</span> <span class="o">=</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s2">&quot;fbc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">SBSpF</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">CF</span> <span class="o">=</span> <span class="n">SBSpF</span><span class="o">.</span><span class="n">getChemicalFormula</span><span class="p">()</span>
                <span class="n">CH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">SBSpF</span><span class="o">.</span><span class="n">getCharge</span><span class="p">())</span>
            <span class="c1">#print CF, CH</span>

        <span class="n">NM</span> <span class="o">=</span> <span class="n">SBSp</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="c1"># get name</span>
        <span class="c1"># to strip a BiGG file see CBTools</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Species</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">boundary</span><span class="o">=</span><span class="n">boundCon</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">NM</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getInitialConcentration</span><span class="p">(),</span> <span class="n">compartment</span><span class="o">=</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getCompartment</span><span class="p">(),</span> <span class="n">charge</span><span class="o">=</span><span class="n">CH</span><span class="p">,</span> <span class="n">chemFormula</span><span class="o">=</span><span class="n">CF</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">LOADANNOT</span><span class="p">:</span>
            <span class="n">S</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="p">{}:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readCOBRANote</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">XMLNode_convertXMLNodeToString</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()))</span>
                <span class="c1">#SBSp.unsetNotes()</span>
            <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">SBSp</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
            <span class="k">del</span> <span class="n">manot</span>
        <span class="n">setCBSBOterm</span><span class="p">(</span><span class="n">SBSp</span><span class="o">.</span><span class="n">getSBOTermID</span><span class="p">(),</span> <span class="n">S</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">SBSp</span><span class="p">))</span>
        <span class="n">SPEC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

    <span class="n">boundary_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SPEC</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_boundary</span><span class="p">]</span>
    <span class="n">spec_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SPEC</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Species load: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># we&#39;ll now deal with global parameters even if they are not used</span>
    <span class="n">PARAM_D</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumParameters</span><span class="p">()):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">p_</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
        <span class="n">pdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
                 <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span>
                 <span class="s1">&#39;constant&#39;</span> <span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">getConstant</span><span class="p">(),</span>
                 <span class="s1">&#39;sbo&#39;</span> <span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">getSBOTermID</span><span class="p">(),</span>
                 <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                 <span class="s1">&#39;annotation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;association&#39;</span> <span class="p">:</span> <span class="p">[],</span>
                 <span class="s1">&#39;notes&#39;</span> <span class="p">:</span> <span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">P</span><span class="p">),</span>
                 <span class="s1">&#39;is_fluxbound&#39;</span>  <span class="p">:</span> <span class="kc">False</span>
                 <span class="p">}</span>
        <span class="k">if</span> <span class="n">LOADANNOT</span><span class="p">:</span>
            <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
            <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manot</span>
            <span class="k">del</span> <span class="n">manot</span>
        <span class="n">PARAM_D</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdict</span>

    <span class="n">GENE_D</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span> <span class="ow">and</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumGeneProducts</span><span class="p">()):</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getGeneProduct</span><span class="p">(</span><span class="n">g_</span><span class="p">)</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="n">gdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">gid</span><span class="p">,</span>
                     <span class="c1">#&#39;value&#39; : G.getValue(),</span>
                     <span class="c1">#&#39;constant&#39; : P.getConstant(),</span>
                     <span class="s1">&#39;sbo&#39;</span> <span class="p">:</span> <span class="n">G</span><span class="o">.</span><span class="n">getSBOTermID</span><span class="p">(),</span>
                     <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">G</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span>
                     <span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">G</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span>
                     <span class="s1">&#39;annotation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s1">&#39;notes&#39;</span> <span class="p">:</span> <span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">G</span><span class="p">),</span>
                     <span class="p">}</span>
            <span class="k">if</span> <span class="n">LOADANNOT</span><span class="p">:</span>
                <span class="n">gdict</span><span class="p">[</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
                <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gdict</span><span class="p">[</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manot</span>
                <span class="k">del</span> <span class="n">manot</span>
            <span class="n">GENE_D</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdict</span>

    <span class="n">REAC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">FB_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">GPR_D</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">reactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reactionsReversability</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gprregex</span>  <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\w+&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumReactions</span><span class="p">()):</span>
        <span class="n">SBRe</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">R_id</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">HAVE_FBC</span> <span class="ow">and</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># deal with new style fluxbounds</span>
            <span class="n">RFBCplg</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="s1">&#39;fbc&#39;</span><span class="p">)</span>
            <span class="n">lfbid</span> <span class="o">=</span> <span class="n">RFBCplg</span><span class="o">.</span><span class="n">getLowerFluxBound</span><span class="p">()</span>
            <span class="n">ufbid</span> <span class="o">=</span> <span class="n">RFBCplg</span><span class="o">.</span><span class="n">getUpperFluxBound</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lfbid</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">fbl</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reaction&#39;</span> <span class="p">:</span> <span class="n">R_id</span><span class="p">,</span>
                       <span class="s1">&#39;operation&#39;</span> <span class="p">:</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_lb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">R_id</span><span class="p">),</span>
                       <span class="s1">&#39;parameter&#39;</span> <span class="p">:</span> <span class="n">lfbid</span><span class="p">,</span>
                       <span class="s1">&#39;annotation&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;sbo&#39;</span>  <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                       <span class="p">}</span>
                <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;association&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_id</span><span class="p">)</span>
                <span class="n">PARAM_D</span><span class="p">[</span><span class="n">lfbid</span><span class="p">][</span><span class="s1">&#39;is_fluxbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">FB_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fbl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ufbid</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">fbu</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reaction&#39;</span> <span class="p">:</span> <span class="n">R_id</span><span class="p">,</span>
                       <span class="s1">&#39;operation&#39;</span> <span class="p">:</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_ub&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">R_id</span><span class="p">),</span>
                       <span class="s1">&#39;parameter&#39;</span> <span class="p">:</span> <span class="n">ufbid</span><span class="p">,</span>
                       <span class="s1">&#39;annotation&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;miriam&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;sbo&#39;</span>  <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">],</span>
                       <span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                       <span class="p">}</span>
                <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;association&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_id</span><span class="p">)</span>
                <span class="n">PARAM_D</span><span class="p">[</span><span class="n">ufbid</span><span class="p">][</span><span class="s1">&#39;is_fluxbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">FB_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fbu</span><span class="p">)</span>

            <span class="c1"># deal with new gene associations (why larry why ...)</span>
            <span class="n">SBgpr</span> <span class="o">=</span> <span class="n">RFBCplg</span><span class="o">.</span><span class="n">getGeneProductAssociation</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">SBgpr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">GPR_id</span> <span class="o">=</span> <span class="n">SBgpr</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">GPR_id</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">GPR_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">GPR_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_gpr&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">R_id</span><span class="p">)</span>
                <span class="n">ass</span> <span class="o">=</span> <span class="n">SBgpr</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ass</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpr_by_id&#39;</span> <span class="p">:</span> <span class="n">ass</span><span class="o">.</span><span class="n">toInfix</span><span class="p">()}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gpr_by_id&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;reaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_id</span>

                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gene_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">## the smart way</span>
                <span class="k">if</span> <span class="n">SBgpr</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sbml_getGeneRefs</span><span class="p">(</span><span class="n">SBgpr</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">(),</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gene_ids&#39;</span><span class="p">])</span>
                    <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbml_getGPRasDictFBCv2</span><span class="p">(</span><span class="n">SBgpr</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">(),</span> <span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">gene_ids_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gene_ids&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
                <span class="n">gene_ids_sorted</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_id&#39;</span><span class="p">]</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_id&#39;</span><span class="p">]</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gene_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">gene_labels_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">x_</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">gene_ids_sorted</span><span class="p">]</span>
                <span class="n">gene_names_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">x_</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">gene_ids_sorted</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_labels_sorted</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_VERSION</span> <span class="o">&gt;=</span> <span class="mi">51300</span><span class="p">:</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">gene_labels_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">],</span>\
                                                                                       <span class="n">gene_ids_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">])</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">gene_labels_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">],</span>\
                                                                                       <span class="n">gene_names_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">gene_ids_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">],</span>\
                                                                                       <span class="n">gene_labels_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">])</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gpr_by_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">gene_ids_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">],</span>\
                                                                                       <span class="n">gene_names_sorted</span><span class="p">[</span><span class="n">x_</span><span class="p">])</span>


                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;gene_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_labels_sorted</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SBgpr</span><span class="o">.</span><span class="n">getSBOTermID</span><span class="p">()</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">SBgpr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">LOADANNOT</span><span class="p">:</span>
                    <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">SBgpr</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
                    <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">SBgpr</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">GPR_id</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manot</span>
                    <span class="k">del</span> <span class="n">manot</span>

        <span class="n">USE_NET_STOICH</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">substrates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">products</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reagents</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">EXREAC</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNumReactants</span><span class="p">()):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getReactant</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">()</span>
            <span class="n">stoi</span> <span class="o">=</span> <span class="o">-</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getReactant</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span><span class="o">.</span><span class="n">getStoichiometry</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">USE_NET_STOICH</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reagents</span><span class="p">:</span>
                    <span class="n">reagents</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reagents</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">substrates</span><span class="p">:</span>
                    <span class="n">substrates</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">substrates</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">boundary_species</span><span class="p">:</span>
                <span class="n">EXREAC</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNumProducts</span><span class="p">()):</span>
            <span class="n">spec2</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getProduct</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">()</span>
            <span class="n">stoi2</span> <span class="o">=</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getProduct</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">getStoichiometry</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">USE_NET_STOICH</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reagents</span><span class="p">:</span>
                    <span class="n">reagents</span><span class="p">[</span><span class="n">spec2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reagents</span><span class="p">[</span><span class="n">spec2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spec2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
                    <span class="n">products</span><span class="p">[</span><span class="n">spec2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">products</span><span class="p">[</span><span class="n">spec2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stoi2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec2</span> <span class="ow">in</span> <span class="n">boundary_species</span><span class="p">:</span>
                <span class="n">EXREAC</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Reaction</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">reversible</span><span class="o">=</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getReversible</span><span class="p">())</span>
        <span class="n">reactionsReversability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getReversible</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">USE_NET_STOICH</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reagents</span><span class="p">:</span>
                <span class="n">R</span><span class="o">.</span><span class="n">addReagent</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">Reagent</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">reagents</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">substrates</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">products</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">substrates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
                <span class="n">products</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">substrates</span><span class="p">:</span>
                <span class="n">R</span><span class="o">.</span><span class="n">addReagent</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">Reagent</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">substrates</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">substrates</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">addReagent</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">Reagent</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">products</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">addReagent</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">Reagent</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_prod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">r</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">products</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
        <span class="k">del</span> <span class="n">reagents</span><span class="p">,</span> <span class="n">substrates</span><span class="p">,</span> <span class="n">products</span>

        <span class="k">if</span> <span class="n">EXREAC</span><span class="p">:</span>
            <span class="n">R</span><span class="o">.</span><span class="n">is_exchange</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">R</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">LOADANNOT</span><span class="p">:</span>
            <span class="n">R</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
            <span class="c1"># only dig for ancient annotation if not using V2</span>
            <span class="k">if</span> <span class="n">FBCver</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">R</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="p">{}:</span>
                <span class="n">R</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readCOBRANote</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">XMLNode_convertXMLNodeToString</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()))</span>
            <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">SBRe</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">R</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
            <span class="k">del</span> <span class="n">manot</span>
        <span class="n">setCBSBOterm</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getSBOTermID</span><span class="p">(),</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">SBRe</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">SBRe</span><span class="o">.</span><span class="n">getNumModifiers</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mo_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getNumModifiers</span><span class="p">()):</span>
                <span class="n">R</span><span class="o">.</span><span class="n">_modifiers_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SBRe</span><span class="o">.</span><span class="n">getModifier</span><span class="p">(</span><span class="n">mo_</span><span class="p">)</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">())</span>
        <span class="n">REAC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reactions load: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># define compartments</span>
    <span class="n">COMP</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getNumCompartments</span><span class="p">()):</span>
        <span class="n">SBcmp</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getCompartment</span><span class="p">(</span><span class="n">c_</span><span class="p">)</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">SBcmp</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">SBcmp</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">SBcmp</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">SBcmp</span><span class="o">.</span><span class="n">getVolume</span><span class="p">()</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="n">SBcmp</span><span class="o">.</span><span class="n">getSpatialDimensions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dimensions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Zero dimension compartment detected: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cid</span><span class="p">))</span>
            <span class="c1"># zero dimension compartments make no sense and are assumed to be L2 artifacts</span>
            <span class="n">dimensions</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Compartment</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">LOADANNOT</span><span class="p">:</span>
            <span class="n">C</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">SBcmp</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
            <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">SBcmp</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">C</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
            <span class="k">del</span> <span class="n">manot</span>
        <span class="n">setCBSBOterm</span><span class="p">(</span><span class="n">SBcmp</span><span class="o">.</span><span class="n">getSBOTermID</span><span class="p">(),</span> <span class="n">C</span><span class="p">)</span>
        <span class="n">C</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">sbml_getNotes</span><span class="p">(</span><span class="n">SBcmp</span><span class="p">))</span>
        <span class="n">COMP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">cid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">C</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compartment load: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># extract fluxbounds</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span> <span class="ow">and</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">FB_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fb_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumFluxBounds</span><span class="p">()):</span>
            <span class="n">SBFb</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getFluxBound</span><span class="p">(</span><span class="n">fb_</span><span class="p">)</span>
            <span class="n">fbd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reaction&#39;</span> <span class="p">:</span> <span class="n">SBFb</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(),</span>
                   <span class="s1">&#39;operation&#39;</span> <span class="p">:</span> <span class="n">SBFb</span><span class="o">.</span><span class="n">getOperation</span><span class="p">(),</span>
                   <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">SBFb</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
                   <span class="p">}</span>
            <span class="n">fb_id</span> <span class="o">=</span> <span class="n">SBFb</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fb_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="n">fbd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_id</span>
            <span class="n">FB_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fbd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FluxBounds load: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># determine bound type and set default bounds for unbound reactions</span>
    <span class="n">CONSTR</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">LboundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">UboundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">AboundReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">DefinedReactionIDs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span> <span class="ow">and</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">FB_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">DefinedReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cntr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;greater&#39;</span><span class="p">,</span><span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">]:</span>
                    <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
                    <span class="n">LboundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;less&#39;</span><span class="p">,</span><span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">]:</span>
                    <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>
                    <span class="n">UboundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">]:</span>
                    <span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;equal&#39;</span>
                    <span class="n">AboundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_bnd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span> <span class="n">O</span><span class="p">)</span>

            <span class="n">FB</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">newId</span><span class="p">)</span>
            <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FB</span><span class="p">)</span>
            <span class="n">cntr</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">boundReactionIDs</span><span class="p">:</span>
                <span class="n">boundReactionIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">])</span>
        <span class="n">ubcntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reactionIDs</span><span class="p">)):</span>
            <span class="n">LBt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">UBt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ABt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DefinedReactionIDs</span><span class="p">:</span>
                <span class="n">LBt</span> <span class="o">=</span> <span class="n">UBt</span> <span class="o">=</span> <span class="n">ABt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">LboundReactionIDs</span><span class="p">:</span>
                <span class="n">LBt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">UboundReactionIDs</span><span class="p">:</span>
                <span class="n">UBt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">]</span> <span class="ow">in</span> <span class="n">AboundReactionIDs</span><span class="p">:</span>
                <span class="n">ABt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">LBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">UBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ABt</span><span class="p">:</span>
                <span class="c1">#print &#39;not LBt and not UBt and not ABt&#39;</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reactionsReversability</span><span class="p">[</span><span class="n">J</span><span class="p">]:</span>
                    <span class="c1">##  print &#39;Adding reversible&#39;</span>
                    <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">##  print &#39;Adding irreversible&#39;</span>
                    <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;upper&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">LBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ABt</span><span class="p">:</span>
                <span class="c1">#print &#39;not LBt and not ABt&#39;</span>
                <span class="c1">#print reactionIDs[J]</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lower&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;greaterEqual&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Added new lower bound&#39;</span><span class="p">,</span> <span class="n">newId</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">UBt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ABt</span><span class="p">:</span>
                <span class="c1">#print &#39;not UBt and not ABt&#39;</span>
                <span class="c1"># print reactionIDs[J]</span>
                <span class="c1">#newId = &#39;UC_%i&#39; % ubcntr</span>
                <span class="n">newId</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bnd&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;upper&#39;</span><span class="p">)</span>
                <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">newId</span><span class="p">,</span> <span class="n">reactionIDs</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="s1">&#39;lessEqual&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
                <span class="n">ubcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># print &#39;Added new upper bound&#39;, newId</span>
    <span class="k">elif</span> <span class="n">HAVE_FBC</span> <span class="ow">and</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bnd</span> <span class="ow">in</span> <span class="n">FB_data</span><span class="p">:</span>
            <span class="n">FB</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">FluxBound</span><span class="p">(</span><span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">],</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">__param__</span> <span class="o">=</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">__sbo_term__</span> <span class="o">=</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;sbo&#39;</span><span class="p">]</span>
            <span class="n">FB</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">FB</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">FB</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">FB</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">bnd</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span>
            <span class="n">CONSTR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FB</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FluxBounds process: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#Create parameters</span>
    <span class="n">PARAM</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_</span> <span class="ow">in</span> <span class="n">PARAM_D</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">p_</span><span class="p">,</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;constant&#39;</span><span class="p">])</span>
        <span class="n">P</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
        <span class="n">P</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span>
        <span class="n">P</span><span class="o">.</span><span class="n">__sbo_term__</span> <span class="o">=</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">]</span>
        <span class="n">P</span><span class="o">.</span><span class="n">_association_</span> <span class="o">=</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;association&#39;</span><span class="p">]</span>
        <span class="n">P</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">PARAM_D</span><span class="p">[</span><span class="n">p_</span><span class="p">][</span><span class="s1">&#39;is_fluxbound&#39;</span><span class="p">]:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">_is_fluxbound_</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">PARAM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter process: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#GPRASSOC = {}</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span> <span class="ow">and</span> <span class="n">LOADGENES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">__HAVE_FBA_ANOT_GENEASS__</span><span class="p">:</span>
            <span class="n">SBGPR</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getListOfGeneAssociations</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="n">SBGPR</span><span class="p">:</span>
                <span class="n">gprid</span> <span class="o">=</span> <span class="n">g_</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">g_</span><span class="o">.</span><span class="n">getReaction</span><span class="p">()</span>
                <span class="n">GPR_D</span><span class="p">[</span><span class="n">gprid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">g_</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">assoc</span> <span class="o">=</span> <span class="n">g_</span><span class="o">.</span><span class="n">getAssociation</span><span class="p">()</span><span class="o">.</span><span class="n">toInfix</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">assoc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">assoc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">gprid</span><span class="p">][</span><span class="s1">&#39;reaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rid</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">gprid</span><span class="p">][</span><span class="s1">&#39;gpr_by_id&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">assoc</span>
                        <span class="n">GPR_D</span><span class="p">[</span><span class="n">gprid</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">sbml_getGPRasDictFBCv1</span><span class="p">(</span>\
                            <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">assoc</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{})</span>


    <span class="c1"># BUILD MODEL, we now need to do it here to link in the fluxobjectives defined in the objective functions</span>
    <span class="n">fm</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">isSetMetaId</span><span class="p">():</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">__metaid__</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getMetaId</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">setMetaId</span><span class="p">(</span><span class="s1">&#39;meta_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="p">))</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model_name</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">model_description</span><span class="p">)</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">())</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">__FBC_STRICT__</span> <span class="o">=</span> <span class="n">FBCstrict</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">__FBC_VERSION__</span> <span class="o">=</span> <span class="n">FBCver</span>

    <span class="c1"># try extract objective functions</span>
    <span class="n">OBJFUNCout</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">HAVE_FBC</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ACTIVE_OBJ</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getActiveObjective</span><span class="p">()</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Active objective:&#39;</span><span class="p">,</span> <span class="n">ACTIVE_OBJ</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
            <span class="c1">#AttributeError</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: No active objective defined&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">why</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">of_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FBCplg</span><span class="o">.</span><span class="n">getNumObjectives</span><span class="p">()):</span>
            <span class="n">SBOf</span> <span class="o">=</span> <span class="n">FBCplg</span><span class="o">.</span><span class="n">getObjective</span><span class="p">(</span><span class="n">of_</span><span class="p">)</span>
            <span class="n">OF</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">SBOf</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">SBOf</span><span class="o">.</span><span class="n">getType</span><span class="p">())</span>
            <span class="n">OF</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">SBOf</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">OF</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="o">==</span> <span class="n">ACTIVE_OBJ</span><span class="p">:</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">addObjective</span><span class="p">(</span><span class="n">OF</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">addObjective</span><span class="p">(</span><span class="n">OF</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ofl_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SBOf</span><span class="o">.</span><span class="n">getNumFluxObjectives</span><span class="p">()):</span>
                <span class="n">SBOfl</span> <span class="o">=</span> <span class="n">SBOf</span><span class="o">.</span><span class="n">getFluxObjective</span><span class="p">(</span><span class="n">ofl_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">SBOfl</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_flobj&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SBOf</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">SBOfl</span><span class="o">.</span><span class="n">getReaction</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="n">SBOf</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
                <span class="n">Oflx</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">FluxObjective</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">SBOfl</span><span class="o">.</span><span class="n">getReaction</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(</span><span class="n">SBOfl</span><span class="o">.</span><span class="n">getCoefficient</span><span class="p">()))</span>
                <span class="n">Oflx</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">SBOfl</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="n">OF</span><span class="o">.</span><span class="n">addFluxObjective</span><span class="p">(</span><span class="n">Oflx</span><span class="p">)</span>
            <span class="n">OBJFUNCout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OF</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ObjectiveFunction load: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPR load: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">manot</span> <span class="o">=</span> <span class="n">sbml_getCVterms</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">manot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">manot</span>
    <span class="k">del</span> <span class="n">manot</span>

    <span class="n">fm</span><span class="o">.</span><span class="n">sourcefile</span> <span class="o">=</span> <span class="n">fname</span>
    <span class="n">sbmh</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getModelHistory</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sbmh</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cdate</span> <span class="o">=</span> <span class="n">sbmh</span><span class="o">.</span><span class="n">getCreatedDate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cdate</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdate</span><span class="o">.</span><span class="n">getYear</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getMonth</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getDay</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getHour</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getMinute</span><span class="p">(),</span> <span class="n">cdate</span><span class="o">.</span><span class="n">getSecond</span><span class="p">())</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setCreatedDate</span><span class="p">(</span><span class="n">cdate</span><span class="p">)</span>
        <span class="n">mdate</span> <span class="o">=</span> <span class="n">sbmh</span><span class="o">.</span><span class="n">getModifiedDate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mdate</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdate</span><span class="o">.</span><span class="n">getYear</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getMonth</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getDay</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getHour</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getMinute</span><span class="p">(),</span> <span class="n">mdate</span><span class="o">.</span><span class="n">getSecond</span><span class="p">())</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setModifiedDate</span><span class="p">(</span><span class="n">mdate</span><span class="p">)</span>
        <span class="n">mCr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sbmh</span><span class="o">.</span><span class="n">getNumCreators</span><span class="p">()):</span>
            <span class="n">sbc</span> <span class="o">=</span> <span class="n">sbmh</span><span class="o">.</span><span class="n">getCreator</span><span class="p">(</span><span class="n">m_</span><span class="p">)</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">addModelCreator</span><span class="p">(</span><span class="n">sbc</span><span class="o">.</span><span class="n">getGivenName</span><span class="p">(),</span> <span class="n">sbc</span><span class="o">.</span><span class="n">getFamilyName</span><span class="p">(),</span> <span class="n">sbc</span><span class="o">.</span><span class="n">getOrganisation</span><span class="p">(),</span> <span class="n">sbc</span><span class="o">.</span><span class="n">getEmail</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">co_</span> <span class="ow">in</span> <span class="n">COMP</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addCompartment</span><span class="p">(</span><span class="n">co_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compartment build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">SPEC</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addSpecies</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Species build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">REAC</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addReaction</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span> <span class="n">create_default_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reaction build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">fbexists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">CONSTR</span><span class="p">:</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">addFluxBound</span><span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">fbexists</span><span class="o">=</span><span class="n">fbexists</span><span class="p">)</span>
        <span class="n">fbexists</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c_</span><span class="o">.</span><span class="n">getReactionId</span><span class="p">(),</span> <span class="n">c_</span><span class="o">.</span><span class="n">getType</span><span class="p">()))</span>
    <span class="k">del</span> <span class="n">fbexists</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FluxBound build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Objective build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p_</span> <span class="ow">in</span> <span class="n">PARAM</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="n">p_</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: duplicate parameter id detected: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">gene_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="n">GENE_D</span><span class="p">:</span>
        <span class="n">gene_labels</span><span class="p">[</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">LOADGENES</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="n">GPR_D</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;reaction&#39;</span> <span class="ow">in</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">]</span> <span class="ow">and</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1">#fm.createGeneProteinAssociation(GPR_D[g_][&#39;reaction&#39;], GPR_D[g_][&#39;gpr_by_id&#39;], gid=g_,\</span>
                                                            <span class="c1">#update_idx=False, altlabels=gene_labels)</span>

                <span class="n">fm</span><span class="o">.</span><span class="n">createGeneProteinAssociationFromTree</span><span class="p">(</span><span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">],</span> <span class="n">gid</span><span class="o">=</span><span class="n">g_</span><span class="p">,</span>\
                                                <span class="n">update_idx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">altlabels</span><span class="o">=</span><span class="n">gene_labels</span><span class="p">)</span>
                <span class="n">gpr</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getGPRassociation</span><span class="p">(</span><span class="n">g_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gpr</span><span class="o">.</span><span class="n">setTree</span><span class="p">(</span><span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">])</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">__updateGeneIdx__</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">FBCver</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">LOADGENES</span><span class="p">:</span>
        <span class="c1"># note we may want to add branches here for using indexes etc etc</span>
        <span class="n">non_gpr_genes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="n">GPR_D</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;gpr_tree&#39;</span> <span class="ow">in</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">]</span> <span class="ow">and</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#print(GPR_D[g_][&#39;gpr_tree&#39;])</span>
                <span class="c1">#fm.createGeneProteinAssociation(GPR_D[g_][&#39;reaction&#39;], GPR_D[g_][&#39;gpr_by_id&#39;], gid=g_, update_idx=False, altlabels=gene_labels)</span>

                <span class="n">fm</span><span class="o">.</span><span class="n">createGeneProteinAssociationFromTree</span><span class="p">(</span><span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;reaction&#39;</span><span class="p">],</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">],</span> <span class="n">gid</span><span class="o">=</span><span class="n">g_</span><span class="p">,</span>\
                                                        <span class="n">update_idx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">altlabels</span><span class="o">=</span><span class="n">gene_labels</span><span class="p">)</span>

                <span class="n">gpr</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getGPRassociation</span><span class="p">(</span><span class="n">g_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gpr</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
                    <span class="n">gpr</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span>
                    <span class="n">gpr</span><span class="o">.</span><span class="n">__sbo_term__</span> <span class="o">=</span> <span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">]</span>
                    <span class="n">gpr</span><span class="o">.</span><span class="n">setTree</span><span class="p">(</span><span class="n">GPR_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;gpr_tree&#39;</span><span class="p">])</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">__updateGeneIdx__</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g_</span> <span class="ow">in</span> <span class="n">GENE_D</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getGene</span><span class="p">(</span><span class="n">g_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="o">!=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
                <span class="n">G</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">G</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
                <span class="n">G</span><span class="o">.</span><span class="n">__sbo_term__</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">]</span>
                <span class="n">G</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span>
                <span class="n">G</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">g_</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">g_</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gene </span><span class="si">{}</span><span class="s1"> is not part of a GPR association. Will create anyway!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g_</span><span class="p">))</span>
                    <span class="n">non_gpr_genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ng_</span> <span class="ow">in</span> <span class="n">non_gpr_genes</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Gene</span><span class="p">(</span><span class="n">ng_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">ng_</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">G</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">ng_</span><span class="p">][</span><span class="s1">&#39;annotation&#39;</span><span class="p">]</span>
            <span class="n">G</span><span class="o">.</span><span class="n">__sbo_term__</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">ng_</span><span class="p">][</span><span class="s1">&#39;sbo&#39;</span><span class="p">]</span>
            <span class="n">G</span><span class="o">.</span><span class="n">miriam</span> <span class="o">=</span> <span class="n">GENE_D</span><span class="p">[</span><span class="n">ng_</span><span class="p">][</span><span class="s1">&#39;miriam&#39;</span><span class="p">]</span>
            <span class="n">G</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">GENE_D</span><span class="p">[</span><span class="n">ng_</span><span class="p">][</span><span class="s1">&#39;notes&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Non-gpr gene detected.&#39;</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">G</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span> <span class="n">fm</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPR build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Groups support</span>
    <span class="n">HAVE_GROUPS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">GRPplg</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getPlugin</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;groups&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">GRPplg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">HAVE_GROUPS</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">why</span><span class="p">))</span>
        <span class="n">GRPplg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">HAVE_GROUPS</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">HAVE_GROUPS</span> <span class="ow">and</span> <span class="n">GRPplg</span><span class="o">.</span><span class="n">getNumGroups</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Groups support: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GRPplg</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Group.getNumGroups: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GRPplg</span><span class="o">.</span><span class="n">getNumGroups</span><span class="p">()))</span>

        <span class="n">s_ids</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getSpeciesIds</span><span class="p">()</span>
        <span class="n">r_ids</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getReactionIds</span><span class="p">()</span>
        <span class="n">c_ids</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getCompartmentIds</span><span class="p">()</span>
        <span class="n">f_ids</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getFluxBoundIds</span><span class="p">()</span>
        <span class="n">o_ids</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getObjectiveIds</span><span class="p">()</span>
        <span class="n">g_ids</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getGeneIds</span><span class="p">()</span>
        <span class="n">grp_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">GRPplg</span><span class="o">.</span><span class="n">getGroup</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GRPplg</span><span class="o">.</span><span class="n">getNumGroups</span><span class="p">())]</span>

        <span class="c1">#print(grp_ids)</span>
        <span class="n">sub_group_assoc</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GRPplg</span><span class="o">.</span><span class="n">getNumGroups</span><span class="p">()):</span>
            <span class="n">GR</span> <span class="o">=</span> <span class="n">GRPplg</span><span class="o">.</span><span class="n">getGroup</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="n">grp_id</span> <span class="o">=</span> <span class="n">GR</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="n">CBModel</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">grp_id</span><span class="p">)</span>
            <span class="n">grp</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">GR</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="n">grp</span><span class="o">.</span><span class="n">setKind</span><span class="p">(</span><span class="n">GROUP_KINDS</span><span class="p">[</span><span class="n">GR</span><span class="o">.</span><span class="n">getKind</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">GR</span><span class="o">.</span><span class="n">getSBOTerm</span><span class="p">()</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">setSBOterm</span><span class="p">(</span><span class="s1">&#39;SBO:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">GR</span><span class="o">.</span><span class="n">getSBOTerm</span><span class="p">())</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>

            <span class="n">notes</span> <span class="o">=</span> <span class="n">GR</span><span class="o">.</span><span class="n">getNotesString</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">notes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;html:body&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/html:body&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>

            <span class="n">annostr</span> <span class="o">=</span> <span class="n">GR</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">annostr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">annostr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">annostr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">id:&#39;</span><span class="p">,</span> <span class="n">grp_id</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;name:&#39;</span><span class="p">,</span> <span class="n">GR</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;kind:&#39;</span><span class="p">,</span> <span class="n">GROUP_KINDS</span><span class="p">[</span><span class="n">GR</span><span class="o">.</span><span class="n">getKind</span><span class="p">()])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sboterm:&#39;</span><span class="p">,</span> <span class="s1">&#39;SBO:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">GR</span><span class="o">.</span><span class="n">getSBOTerm</span><span class="p">())</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;annotations:&#39;</span><span class="p">,</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">GR</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">()))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;notes:&#39;</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>

            <span class="n">LOM</span> <span class="o">=</span> <span class="n">GR</span><span class="o">.</span><span class="n">getListOfMembers</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">LOM</span><span class="o">.</span><span class="n">getSBOTerm</span><span class="p">()</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">setSharedSBOterm</span><span class="p">(</span><span class="s1">&#39;SBO:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">LOM</span><span class="o">.</span><span class="n">getSBOTerm</span><span class="p">())</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>

            <span class="n">lom_notes</span> <span class="o">=</span> <span class="n">LOM</span><span class="o">.</span><span class="n">getNotesString</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lom_notes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">lom_notes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lom_notes</span> <span class="o">=</span> <span class="n">lom_notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;html:body&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/html:body&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">lom_notes</span> <span class="o">=</span> <span class="n">lom_notes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/notes&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">setSharedNotes</span><span class="p">(</span><span class="n">lom_notes</span><span class="p">)</span>


            <span class="n">annostr</span> <span class="o">=</span> <span class="n">LOM</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">annostr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">annostr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">_member_attributes_</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">annostr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sboterm (shared):&#39;</span><span class="p">,</span> <span class="s1">&#39;SBO:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">LOM</span><span class="o">.</span><span class="n">getSBOTerm</span><span class="p">())</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;annotations (shared):&#39;</span><span class="p">,</span> <span class="n">sbml_readKeyValueDataAnnotation</span><span class="p">(</span><span class="n">LOM</span><span class="o">.</span><span class="n">getAnnotationString</span><span class="p">()))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;notes (shared):&#39;</span><span class="p">,</span> <span class="n">lom_notes</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;num members:&#39;</span><span class="p">,</span> <span class="n">GR</span><span class="o">.</span><span class="n">getNumMembers</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GR</span><span class="o">.</span><span class="n">getNumMembers</span><span class="p">()):</span>
                <span class="n">idr</span> <span class="o">=</span> <span class="n">GR</span><span class="o">.</span><span class="n">getMember</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">getIdRef</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">member idRef:&#39;</span><span class="p">,</span> <span class="n">GR</span><span class="o">.</span><span class="n">getMember</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">getIdRef</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">s_ids</span><span class="p">:</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">s_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idr</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">r_ids</span><span class="p">:</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">r_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idr</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">f_ids</span><span class="p">:</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">flux_bounds</span><span class="p">[</span><span class="n">f_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idr</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">g_ids</span><span class="p">:</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">genes</span><span class="p">[</span><span class="n">g_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idr</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">c_ids</span><span class="p">:</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">c_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idr</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">o_ids</span><span class="p">:</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="n">o_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idr</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">idr</span> <span class="ow">in</span> <span class="n">grp_ids</span><span class="p">:</span>
                    <span class="c1">#print(idr)</span>
                    <span class="c1">#print(grp_id)</span>
                    <span class="c1"># scanning for subgroup members to assign later</span>
                    <span class="k">if</span> <span class="n">grp_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_group_assoc</span><span class="p">:</span>
                        <span class="n">sub_group_assoc</span><span class="p">[</span><span class="n">grp_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">idr</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sub_group_assoc</span><span class="p">[</span><span class="n">grp_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping group </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> member </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">, it is an incompatible type.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GR</span><span class="o">.</span><span class="n">getId</span><span class="p">(),</span> <span class="n">idr</span><span class="p">))</span>

            <span class="n">fm</span><span class="o">.</span><span class="n">addGroup</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">s_ids</span><span class="p">,</span> <span class="n">r_ids</span><span class="p">,</span> <span class="n">c_ids</span><span class="p">,</span> <span class="n">f_ids</span><span class="p">,</span> <span class="n">o_ids</span><span class="p">,</span> <span class="n">g_ids</span>

        <span class="c1"># adding subgroups</span>
        <span class="k">for</span> <span class="n">grp_</span> <span class="ow">in</span> <span class="n">sub_group_assoc</span><span class="p">:</span>
            <span class="n">GRP</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">getGroup</span><span class="p">(</span><span class="n">grp_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sg_</span> <span class="ow">in</span> <span class="n">sub_group_assoc</span><span class="p">[</span><span class="n">grp_</span><span class="p">]:</span>
                <span class="n">GRP</span><span class="o">.</span><span class="n">addMember</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">getGroup</span><span class="p">(</span><span class="n">sg_</span><span class="p">))</span>
                <span class="c1">#print(&#39;Adding: {} to {}&#39;.format(sg_, grp_))</span>
        <span class="c1">#print(sub_group_assoc)</span>
        <span class="k">del</span> <span class="n">sub_group_assoc</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">CONSTR</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: No FBC flux bounds were defined.&#39;</span><span class="p">)</span>
        <span class="c1">#time.sleep(1)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">OBJFUNCout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: No FBC objective functions were defined.&#39;</span><span class="p">)</span>
        <span class="c1">#time.sleep(1)</span>
    <span class="n">fm</span><span class="o">.</span><span class="n">_SBML_LEVEL_</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">del</span> <span class="n">SPEC</span><span class="p">,</span> <span class="n">GENE_D</span><span class="p">,</span> <span class="n">REAC</span><span class="p">,</span> <span class="n">PARAM</span><span class="p">,</span> <span class="n">PARAM_D</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">NMATRIX_TYPE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">buildStoichMatrix</span><span class="p">(</span><span class="n">matrix_type</span><span class="o">=</span><span class="n">NMATRIX_TYPE</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">why</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">why</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: unable to construct stoichiometric matrix&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nmatrix build: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SBML3 load time: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time00</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

    <span class="c1">#del M, D</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_sbml_model</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SBML object return disabled&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fm</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="sbml_readCOBRANote"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_readCOBRANote">[docs]</a><span class="k">def</span> <span class="nf">sbml_readCOBRANote</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses a COBRA style note from a XML string</span>

<span class="sd">     - *s* an XML string</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_ann</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cobra_p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">re_html_cobra_p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">html_c_p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">re_html_p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cobra_p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">cobra_p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cobra_p</span><span class="p">:</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;html:p&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/html:p&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">new_ann</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()})</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">html_c_p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">cobra_p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">html_c_p</span><span class="p">:</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">new_ann</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()})</span>
    <span class="k">elif</span> <span class="s1">&#39;&lt;span xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">hPs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">re_html_p</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">hPs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hPs</span><span class="p">:</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">re_html_span</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;span&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">new_ann</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    <span class="c1">#print new_ann</span>
    <span class="k">return</span> <span class="n">new_ann</span></div>

<div class="viewcode-block" id="sbml_getCVterms"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_getCVterms">[docs]</a><span class="k">def</span> <span class="nf">sbml_getCVterms</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the MIRIAM compliant CV terms and return a MIRIAMAnnotation or None</span>

<span class="sd">     - *sb* a libSBML SBase derived object</span>
<span class="sd">     - *model* is this a BQmodel term</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">sb</span><span class="o">.</span><span class="n">getNumCVTerms</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">getNumCVTerms</span><span class="p">()):</span>
            <span class="n">cvt</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">getCVTerm</span><span class="p">(</span><span class="n">c_</span><span class="p">)</span>
            <span class="n">resrc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">cvt</span><span class="o">.</span><span class="n">getQualifierType</span><span class="p">()</span> <span class="o">==</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">BIOLOGICAL_QUALIFIER</span><span class="p">:</span>
                <span class="n">qual</span> <span class="o">=</span> <span class="n">BQ2CBMMAP</span><span class="p">[</span><span class="n">cvt</span><span class="o">.</span><span class="n">getBiologicalQualifierType</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qual</span> <span class="o">=</span> <span class="n">BQM2CBMMAP</span><span class="p">[</span><span class="n">cvt</span><span class="o">.</span><span class="n">getModelQualifierType</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cvt</span><span class="o">.</span><span class="n">getNumResources</span><span class="p">()):</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="n">cvt</span><span class="o">.</span><span class="n">getResourceURI</span><span class="p">(</span><span class="n">r_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qual</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">uri</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">resrc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">qual</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">resrc</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">man</span> <span class="o">=</span> <span class="n">MIRIAMannotation</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">q_</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r_</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="n">q_</span><span class="p">]:</span>
                <span class="n">man</span><span class="o">.</span><span class="n">addIDorgURI</span><span class="p">(</span><span class="n">q_</span><span class="p">,</span> <span class="n">r_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">man</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="sbml_setCVterms"><a class="viewcode-back" href="../../modules_doc.html#cbmpy.CBXML.sbml_setCVterms">[docs]</a><span class="k">def</span> <span class="nf">sbml_setCVterms</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">uridict</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add MIRIAM compliant CV terms to a sbml object from a CBM object</span>

<span class="sd">     - *sb* a libSBML SBase derived object</span>
<span class="sd">     - *uridict* a dictionary of uri&#39;s as produced by getAllMIRIAMUris()</span>
<span class="sd">     - *model* is this a BQmodel term [deprecated attribute, ignored and autodetected]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">t_</span> <span class="ow">in</span> <span class="n">uridict</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uridict</span><span class="p">[</span><span class="n">t_</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">cv</span>
            <span class="c1">#print(t_)</span>
            <span class="c1">#print(uridict[t_])</span>
            <span class="k">if</span> <span class="n">t_</span> <span class="ow">in</span> <span class="n">CBM2BQMAP</span><span class="p">:</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">CVTerm</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">BIOLOGICAL_QUALIFIER</span><span class="p">)</span>
                <span class="n">cv</span><span class="o">.</span><span class="n">setBiologicalQualifierType</span><span class="p">(</span><span class="n">CBM2BQMAP</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t_</span><span class="p">)])</span>
                <span class="c1">#print(CBM2BQMAP[t_])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">CVTerm</span><span class="p">(</span><span class="n">libsbml</span><span class="o">.</span><span class="n">MODEL_QUALIFIER</span><span class="p">)</span>
                <span class="n">cv</span><span class="o">.</span><span class="n">setModelQualifierType</span><span class="p">(</span><span class="n">CBM2BQMMAP</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t_</span><span class="p">)])</span>
            <span class="k">for</span> <span class="n">u_</span> <span class="ow">in</span> <span class="n">uridict</span><span class="p">[</span><span class="n">t_</span><span class="p">]:</span>
                <span class="c1">#print(u_)</span>
                <span class="c1">#print(uridict[t_])</span>
                <span class="k">if</span> <span class="n">cv</span><span class="o">.</span><span class="n">addResource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u_</span><span class="p">))</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO failure adding MIRIAM resource </span><span class="si">{}</span><span class="s1"> to: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u_</span><span class="p">,</span> <span class="n">sb</span><span class="o">.</span><span class="n">getId</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">sb</span><span class="o">.</span><span class="n">addCVTerm</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="o">!=</span> <span class="n">libsbml</span><span class="o">.</span><span class="n">LIBSBML_OPERATION_SUCCESS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: failure adding MIRIAM term: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">addCVTerm</span><span class="p">(</span><span class="n">cv</span><span class="p">)))</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../cbmpy.html">
              <img class="logo" src="../../_static/pysces_cbm1_head.jpg" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../cbmpy.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2018, Brett G. Olivier.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>